<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[吕钊]]></title>
  <link href="http://www.zlu.me/atom.xml" rel="self"/>
  <link href="http://www.zlu.me/"/>
  <updated>2013-09-28T08:23:51+08:00</updated>
  <id>http://www.zlu.me/</id>
  <author>
    <name><![CDATA[Zhao Lu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Quick Survey Of Rails CMS]]></title>
    <link href="http://www.zlu.me/blog/2013/09/27/quicksurveyofrailscms/"/>
    <updated>2013-09-27T21:37:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/09/27/quicksurveyofrailscms</id>
    <content type="html"><![CDATA[<p>Selecting a Content Management System (CMS) is never an easy task.  I have recently spent a good amount of time tinkering with different implementations and would like to share my learnings here.</p>

<p>There are many solutions on the market so you should solidify your requirements to help you narrow down the choices.  This CMS will be used for <a href="https://foryogi.com">ForYogi</a> with the following requirements:</p>

<ul>
<li>Admin can add tutorials on how to use the site for teachers/studios/users.</li>
<li>Admin can add articles for yoga-related topics into a knowledge base.  Topics can be as simple as definition of  <em>yogi</em> or Sanskrit terminologies such as <em>asana</em>.</li>
<li>Admin can add help content which can be accessed by the application and displayed in various parts of the app.</li>
<li>Admin can add FAQs.</li>
<li>Users can search contents in Knowledge Base.</li>
<li>Admin can customize layout and css style.</li>
<li>Drop-in support for existing Rails4 (Ruby 2) project.</li>
<li>Inexpensive &ndash; Some hosted solution can get pricey depending on storage and other factors.</li>
</ul>


<h4>General Impression</h4>

<p> CMS is often used by developers to create customizable mostly static websites for clients.  Most of the Rails CMS gems have over the years, <a href="http://guides.rubyonrails.org/engines.html%E2%80%8E">enginfied</a>, providing drop-in support for existing Rails apps.</p>

<p><strong><a href="http://refinerycms.com">RefineryCMS</a></strong></p>

<p>There are <a href="http://railscasts.com/episodes/332-refinery-cms-basics">free</a> and <a href="http://railscasts.com/episodes/333-extending-refinery-cms">pro</a> episodes of it on RailsCasts.com.  I don&rsquo;t have a pro-account so I only examined the free content.  My impression is it&rsquo;s easy to set it ground-up with customized style.  This CMS has been around for a long time and has a good community build around it.  There are two factors against me choosing it though:</p>

<ul>
<li>At the time of writing, its Rails4 support is <a href="https://github.com/refinery/refinerycms/commit/d9e7d4dfda3256ece0b527da269a1f2643a9afc2">work in progress</a>.</li>
<li>Integrating it with an existing application using devise is quite involved according to this <a href="http://refinerycms.com/guides/with-an-existing-rails-31-devise-app">article</a>.</li>
</ul>


<p><strong><a href="http://locomotivecms.com">LocomotivesCMS</a></strong></p>

<p>This one has a nicely styled site (compare to some other CMS) but has a few things that concerns me:</p>

<ul>
<li>It requires MongoDB.  It is not a big deal. I&rsquo;m not using Mongo in my current setup.  I can get a small setup using Heroku add-on but I&rsquo;d probably have to pay to get a storage bump-up in the near future.</li>
<li>Weak <a href="http://doc.locomotivecms.com">documentation</a>.  I looked through the content and found documentation is quite superficial and lacking depth.  It is understandable as they offer a hosting solution.</li>
<li>The <a href="https://github.com/locomotivecms/engine/issues/746">issue</a> on Rails4 support concerns me the most:

<blockquote><p>Probably by the end of the year. However, It could happen sooner depending on how successful would be our hosting solution…Long story short, we need financial support to handle the next big version of the engine which will include a new UI.</p></blockquote></li>
</ul>


<p>As there is no guarantee for a rather future release of Rails4 support (at least not in their current roadmap), I pass.   <br/>
<strong><a href="http://alchemy-cms.com">AlchemyCMS</a></strong></p>

<p>I first learned about this CMS through the comments on the free RailsCasts episode.  They argued about why they are better than refineryCMS.  I liked their idea of storing pure content, not css style and layouts in database.  It&rsquo;ll only make migration to other systems easier.  I also noticed that they have a <a href="https://github.com/magiclabs/alchemy_cms/tree/3.0-dev">3.0-dev branch</a> supporting Rails4 with this <a href="fe94bedc761484940071129277970a6cd65fba10">sha</a>.  Installation has proved to be hard as there are a few conflict in various gems (if you use activeadmin and devise).  I was able to install it after some struggle.  However, I encountered problems running it (devise login, actions_cache).  It was just wasting more time than I wanted at this point.</p>

<p><strong><a href="">BrowserCMS</a></strong></p>

<p>The first problem I had is jquery-rails version being too low even for their <a href="https://github.com/browsermedia/browsercms">Rails 4 master branch</a> for which <a href="https://github.com/peakpg">peakpg</a> opened <a href="https://github.com/browsermedia/browsercms/issues/625">an issue</a>.  After fixing that in my own fork, I continue running into other problems.  Basically the Rails4 support is not quite ready yet.</p>

<p><strong><a href="">ComfortableMexicanSofa</a></strong></p>

<p>This cleverly named gem is lesser popular than the other gems I&rsquo;ve looked at based on the number of watches and forks on github.  However, it is the only one that worked out-of-box with an existing Rails4 app with devise authentication.  The documentation explains the theory well but lacks examples.  I suggest watching the RailsCasts <a href="http://railscasts.com/episodes/118%E2%80%8E">free episode</a> on <a href="http://liquidmarkup.org/%E2%80%8E">Liquid template</a> and really understand <a href="https://github.com/comfy/comfortable-mexican-sofa/wiki/Tags">tags</a> and how to apply partials/helpers.</p>

<p>Here is how to create a simple navigation for all the pages.  According to the <a href="https://github.com/comfy/comfortable-mexican-sofa/wiki/Creating-navigation-from-pages">guide</a>, you need to add something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% @cms_site.pages.root.children.published.each </span><span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= link_to(page.label, page.full_path) %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But where do you add it?  I tried to create a new partial _kb.html.erb under app/views/layouts and got a no partial found error.  It is looking for cms_content and application directories for partials.  So I created app/views/cms_content directory and moved the partial there.  This kind/level of details should, ideally, be in the guide.
You can then invoke this partial inside of a layout:</p>

<p>Once you get how Liquid template markup works with comfy sofa, it becomes intuitive to create sites/layouts/pages.</p>

<h3>Conclusion</h3>

<p>I selected ComfortableMexicanSofa for its ease in integration into an existing Rails4 application with devise authentication.  The customization seems to be quite flexible.  It is also possible to invoke it from the main app which enables me to display help content in various places inside of the app.  The only requirement I haven&rsquo;t looked at is search.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Never Ending Journey On The Perfect Blogging Setup]]></title>
    <link href="http://www.zlu.me/blog/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup/"/>
    <updated>2013-09-18T09:58:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup</id>
    <content type="html"><![CDATA[<p>Once in a while I search for a better blogging solution.  Like many others I&rsquo;ve used Wordpress, Blogger, and Tumblr.  I&rsquo;ve also used more technical approaches such as self-hosted Wordpress.  I use <a href="http://octopress.org">Octopress</a> for this blog.  I have tempted to write my own blog software but some developers do.  Remy wrote his own <a href="http://www.whoisremy.com">blog</a> in RubyOnRails.</p>

<p>I recently needed to setup a blog for <a href="https://foryogi.com">ForYogi</a>.  I tried Tumblr, again, for a while.  I still don&rsquo;t like it.  I think it&rsquo;s better suited for a quick photo upload which some short description.  Instapaper&rsquo;s blog use it for obvious reason, but it&rsquo;s not visually appealing to me.  Knowing what Yahoo tends to do to their purchases, I decided to abandon it.  Wordpress is a bit too overwhelming for me, with its custom domain and many packages they sell.  I do like the plethora plugins and vibrant community Wordpress have though.  Blogger is the best choice for a hosted solution providing all I need for free.  I don&rsquo;t believe Blogger will be part of Google&rsquo;s killing spree as it is being used by many bloggers for advertising.  But its editing interface feels like MS Word in 1997.  Its post display is like a typical Google product, lacking the simplicity and elegancy of what Apple has.</p>

<p>I played around with <a href="http://roon.io">Roon</a> and liked their editing interface which supports Markdown.  They charge $12 annually for custom domain which you can get for free from many other services.  But that&rsquo;s fine, I&rsquo;m always up for supporting start-ups.  After making the first test post, I found something I don&rsquo;t quite like.  There&rsquo;s a rather large Roon icon on the posting, if you specify an image for it.  Roon seems to take the similar approach as Medium.  Focusing on content (hence no in-article commenting) is good.  But essentially you are writing <em><a href="http://www.marco.org/2013/08/05/be-your-own-platform">for free</a></em> for an online magazine.  The worst part though, is in their <a href="https://roon.io/terms">terms</a>:</p>

<blockquote><p>By submitting, posting or displaying content on or through the Service, you grant Nothing Magical Inc. a worldwide, non-exclusive, royalty-free license to use, adapt, publish, and display the content in any and all media or distribution methods (now known or later developed).</p></blockquote>

<p>To me, this is a <strong>deal-breaker</strong>.</p>

<p><a href="http://scriptgr.am">Scriptgr.am</a>, which integrates with Dropbox and has more features than Roon, is better suited for me.</p>

<p>Through the searching process, I figured out what I wanted:</p>

<ul>
<li>Support of markdown</li>
<li>Clean interface</li>
<li>True ownership of my content</li>
<li>Free custom domain</li>
<li>Least amount of coding</li>
<li>Ease of deployment and minimum effort of maintenance</li>
</ul>


<p><strong>My final setup is simple</strong></p>

<ul>
<li>Jekyll, a blog-aware static site generator</li>
<li>Mou, a desktop markdown editor</li>
<li>Github Pages</li>
</ul>


<p>Working with <a href="http://jekyllrb.com">Jekyll</a> is a pleasure.  I can use my editor of my choice to write postings and git to version control them.  Currently I&rsquo;m tinkering with <a href="mouapp.com">Mou</a>, a markdown editor.  I like its real-time preview pane and wishing emacs&#8217; markdown mode could offer it.  Github pages is fast and free.  I created a public repo &ndash; <a href="https://github.com/foryogi/foryogi.github.io">foryogi.github.io</a> and pushed to master.  Some online documentation mentions pushing to gh-pages branch, which did not work for me.  I also had to create a CNAME file by <code>echo "blog.foryogi.com" &gt; CNAME</code> at the root of project.  This is required for GH page redirect for subdomains to work.  Github has some problem with generating Jekyll-based pages and I haven&rsquo;t getting deployment emails at all.</p>

<p>I also added Twitter bootstrap and font-awesome.  I plan to add Google font to it next.  I also added support for Heroku, which requires Procfile, config.ru, and add a Heroku config var for the <a href="https://github.com/mattmanning/heroku-buildpack-ruby-jekyll">build pack</a>.  This <a href="https://github.com/mattmanning/heroku-buildpack-ruby-jekyll/pull/9">pull request</a> is useful to get around a build failure due to a change in Jekyll build command.</p>

<p>I prefer GH page to Heroku because the initial load of Heroku site is always very slow.  GH doesn&rsquo;t have that problem.  I added heroku for backup in case Github goes down. It&rsquo;s trivial to point CNAME to heroku app.  If Amazon EC2 is down, then I&rsquo;m out of luck (I think GH and Heroku both use EC2, but maybe they also use Rackspace).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[System Calls In Ruby]]></title>
    <link href="http://www.zlu.me/blog/2013/06/03/system-calls-in-ruby/"/>
    <updated>2013-06-03T00:42:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/06/03/system-calls-in-ruby</id>
    <content type="html"><![CDATA[<p>There are a few ways to execute system commands in Ruby: backticks, system, exec, %x[], and Open3#popen3.
We will take a look at the their differences and briefly discuss security concerns of applying them.</p>

<h2>Backticks (Kernel#`)</h2>

<p>When using backticks, the result is returned as string.  Process status of method execution is stored in $?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">006</span> <span class="o">&gt;</span> <span class="sb">`ls`</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">007</span> <span class="o">&gt;</span> <span class="vg">$?</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">_</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">success?</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>%x</h2>

<p>%x() or %x[] is similar to using backticks.</p>

<h2>Kernel#system</h2>

<p>When using system method, the result is true or false depending on whether the command is executed successfully.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'><span class="no">CHANGELOG</span><span class="o">.</span><span class="n">markdown</span> <span class="no">README</span><span class="o">.</span><span class="n">markdown</span>    <span class="n">config</span><span class="o">.</span><span class="n">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
</span><span class='line'><span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="o">.</span><span class="n">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="no">Gemfile</span><span class="o">.</span><span class="n">lock</span>       <span class="n">_config</span><span class="o">.</span><span class="n">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;ls a&#39;</span>
</span><span class='line'><span class="ss">ls</span><span class="p">:</span> <span class="ss">a</span><span class="p">:</span> <span class="no">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Kernel#exec</h2>

<p>exec replaces the current process by running the given external command.  If you invoke exec in irb, then the irb process
will be replaced by the running external command.  You will get the shell prompt back after exec finishes.  If you invoke
exec in a ruby program, that program will stop execution (just like the irb process).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="ss">mba</span><span class="p">:</span><span class="o">~</span><span class="sr">/projects/me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="n">irb</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">exec</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'><span class="no">CHANGELOG</span><span class="o">.</span><span class="n">markdown</span> <span class="no">README</span><span class="o">.</span><span class="n">markdown</span>    <span class="n">config</span><span class="o">.</span><span class="n">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
</span><span class='line'><span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="o">.</span><span class="n">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="no">Gemfile</span><span class="o">.</span><span class="n">lock</span>       <span class="n">_config</span><span class="o">.</span><span class="n">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="ss">mba</span><span class="p">:</span><span class="o">~</span><span class="sr">/projects/me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Open3#popen3</h2>

<p>popen3 executes the command while opening stdin, stdout, and stderr and a thread to wait for the command execution.</p>

<figure class='code'><figcaption><span>stdout with successfully execution </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">010</span> <span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;open3&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">011</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 run&gt;]</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">012</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">_</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 dead&gt;]</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">014</span> <span class="o">&gt;</span> <span class="n">o</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>stderr with unsuccessfully execution </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">027</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;ls a&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="o">|</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">02</span><span class="mi">9</span><span class="o">?&gt;</span>   <span class="nb">p</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">030</span><span class="o">?&gt;</span>   <span class="k">end</span>
</span><span class='line'><span class="s2">&quot;ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a few variations of popen3 methods such as popen2 where a couple of streams are merged 2&amp;>1, for example.</p>

<h2>Security Concerns</h2>

<p>Much like SQL Injection, similar things can happen when using these method calls.
Consider a command like <code>ls a;rm a</code>.  or even worse <code>ls a;rm -rf *</code>
We can address such concerns with another form of popen3(cmd, args).  For the command above, it is
<code>popen3('ls', 'a;rm -rf*')</code>.  The last part of the command is interpreted as the options for <code>ls</code>.</p>

<p>Take a look at this playful little app <a href="https://github.com/zlu/web_shell">web_shell</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Initialization Is An Interesting Thing]]></title>
    <link href="http://www.zlu.me/blog/2013/05/29/initialization-is-an-interesting-thing/"/>
    <updated>2013-05-29T22:51:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/05/29/initialization-is-an-interesting-thing</id>
    <content type="html"><![CDATA[<p>Have you ever tried to define <code>initialized</code> method for an <code>ActiveRecord</code>?</p>

<p>Try it if you haven&rsquo;t.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyRecord &lt; ActiveRecord::Base
</span><span class='line'>  def initialize
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>MyRecord.new  #&lt;MyRecord not initialized&gt;
</span></code></pre></td></tr></table></div></figure>


<p>This is probably not what you have expected.  Why is MyRecord not initialized?</p>

<p>Well, ActiveRecord::Base has already defined <code>initialize</code> method.  It is used to instantiate Rails models.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def initialize(attributes = nil, options = {})</span></code></pre></td></tr></table></div></figure>


<p>If you really want to override it with your own version, you would want to do this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyRecord &lt; ActiveRecord::Base
</span><span class='line'>  def initialize(attributes = nil, options = {})
</span><span class='line'>    super
</span><span class='line'>    # now do your own initialization
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>MyRecord.new</span></code></pre></td></tr></table></div></figure>


<p>This should build a new AR for you (if you have a defined my_records table in database).</p>

<p>Rails provides a cleaner way to handle this via after_initilize callback.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyClass &lt; ActiveRecord::Base
</span><span class='line'>  after_initialize do
</span><span class='line'>    # do your thing here
</span><span class='line'>    puts 'more to do after initialization'
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><code>after_initialize</code> is called when ActiveRecord is instantiated and before it is saved.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lost Shell Commands?]]></title>
    <link href="http://www.zlu.me/blog/2013/05/27/lost-shell-commands/"/>
    <updated>2013-05-27T21:32:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/05/27/lost-shell-commands</id>
    <content type="html"><![CDATA[<p>Sometime when you modify .bashrc or .bash_profile and source it, you may notice that you have &lsquo;lost&rsquo; your shell commands.
You will see &lsquo;command not found&rsquo; for the simplest commands such as <code>ls</code> and <code>which</code>.</p>

<p>Most like this happens because you have accidentally override your PATH.  So instead of doing:</p>

<p><code>PATH=my/custom/path:$PATH</code>, you did <code>PATH=my/custom/path</code>.</p>

<p>Here&rsquo;s a simpel way to fix it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'PATH=/bin:/usr/bin' &gt; foo && source foo</span></code></pre></td></tr></table></div></figure>


<p>This will get recover your commands so you can modify your .bashrc or .bash_profile with nano.  Remember to back up a working
version before working on them next time :)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Postgres Gotchas]]></title>
    <link href="http://www.zlu.me/blog/2013/02/04/postgres-gotchas/"/>
    <updated>2013-02-04T11:16:00+08:00</updated>
    <id>http://www.zlu.me/blog/2013/02/04/postgres-gotchas</id>
    <content type="html"><![CDATA[<p>I run postgres locally for development on OS X (mountain lion).  I&rsquo;ve run into a few issues and am documenting solutions
here.</p>

<h2>Issue 1: Insufficient Shared Memory</h2>

<p>Postgres requires sufficient shared memory or it won&rsquo;t start.  If there isn&rsquo;t enough, postgres server will fail to start
and in server.log you will see this:</p>

<pre><code>FATAL:  could not create shared memory segment: Cannot allocate memory
DETAIL:  Failed system call was shmget(key=5432001, size=3391488, 03600).
HINT:  This error usually means that PostgreSQL's request for a shared memory segment exceeded available memory or swap space, or exceeded your kernel's SHMALL parameter.  You can either reduce the request size or reconfigure the kernel with larger SHMALL.  To reduce the request size (currently 3391488 bytes), reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections.
</code></pre>

<p>There are two ways to correct this problem.</p>

<ol>
<li><p>Up the shared memory configuration.</p>

<p> On mountain lion, you could create or modify your /etc/sysctl.conf so it has this:</p>

<pre><code> zlu@zlu-mba:~/projects/me/blog-zlu (master)$ cat /etc/sysctl.conf
 kern.sysv.shmmax=4194304
 kern.sysv.shmmin=1
 kern.sysv.shmmni=32
 kern.sysv.shmseg=8
 kern.sysv.shmall=1024
</code></pre>

<p> Make sure shmmax is large enough for postgres and other software that requires shared memeory.
 To figure out how much shared memeory you will need for postgres, take a look at postgresql.conf (probably under /usr/local/var/postgres)</p>

<pre><code> max_connections = 20                    # (change requires restart)
 # Note:  Increasing max_connections costs ~400 bytes of shared memory per
 # connection slot, plus lock space (see max_locks_per_transaction).
</code></pre>

<p> More details can be found here:
 <a href="http://www.postgresql.org/docs/9.2/static/kernel-resources.html#SYSVIPC">Upgrade Postgres</a></p></li>
<li><p>Reduce resource requirements
 In postgresql.conf you could search for &ldquo;shared memory&rdquo; and see all resources (such as max_connections and max_prepared_transactions).
 Reduce the requirements as you see fit.</p></li>
</ol>


<h2>Issue 2: Upgrading from 9.1.x to 9.2.x</h2>

<p>If you need to migration database, you may run into path issues.</p>

<p>Here is the steps that work for me:</p>

<ol>
<li>Backup <strong>BEFORE</strong> you install 9.2 (with homebrew).  This is important if you want to avoid the hussle later with two versions
 of <code>pg_ctl</code> stomping onto each other.  While the 9.1.x server is running, use <code>pg_dumpall</code> to export the database.</li>
<li>Stop 9.1.x server</li>
<li>mv the data directory (e.g. /usr/local/var/postgres) to postgres.bk.</li>
<li>Install postgres 9.2.x (with homebrew).</li>
<li>Create symlink for plist file for launchctl (it is named differently than 9.1 so you will need to do it again).  The post-install
 instruction of homebrew contains the exact command.
     cp /usr/local/Cellar/postgresql/9.2.1/homebrew.mxcl.postgresql.plist ~/Library/LaunchAgents/
 And remove the plist file that belonged to 9.1.x</li>
<li><code>initdb</code> (this creates the 9.2.x version of the database).</li>
<li>Import the postgres data backup from the previous <code>pg_dumpall</code> command.</li>
<li>Load plist:
     launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.postgresql.plist</li>
</ol>


<p><a href="http://www.postgresql.org/docs/9.2/static/upgrading.html">Migrating Postgres</a></p>

<h2>Issue 3: Rails Server Fails to Start</h2>

<p>If you are doing Rails development, after upgrade postgres and issue &lsquo;rails s&rsquo; for your project, you may see this error
which fails Rails server from starting:</p>

<pre><code>PGError (could not connect to server: Permission denied
    Is the server running locally and accepting
    connections on Unix domain socket "/var/pgsql_socket/.s.PGSQL.5432"?
)
</code></pre>

<p>Since postgres 9.2, the unix socket file has changed to /var/pgsql_socket/alt.  The pg gem is compiled against the older version
of postgres (9.1.x) so it looks for the socket file in wrong location.  The easist thing to do is to uninstall and reinstall
pg gem.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Housekeeping RVM]]></title>
    <link href="http://www.zlu.me/blog/2012/11/10/housekeeping-rvm/"/>
    <updated>2012-11-10T18:13:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/11/10/housekeeping-rvm</id>
    <content type="html"><![CDATA[<p>When a new version of Ruby comes out, I like to use RVM to install it, migrate ruby gems to new ruby, and remove the
older version of ruby.  This prevent the disk bloated with different versions of Rubies and duplicate gem(sets).</p>

<p>First, always update the RVM because it&rsquo;ll also update known list of Ruby.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm get stable
</span></code></pre></td></tr></table></div></figure>


<p>Then list known versions of Rubies</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm list known
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-p286
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-<span class="o">[</span>p327<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-head
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>2.0.0-preview1
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>The output shows abridged result since the full list is long.  I currently have p286 installed and I&rsquo;m about to install p327
because it contains a security fix for DoS attack in p286.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm install 1.9.3
</span></code></pre></td></tr></table></div></figure>


<p>Since p327 is the default stable version (as indicated by []), the command above is sufficient.</p>

<p>Now you can migrate the gem(sets)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm migrate 1.9.3-p286 1.9.3-p327
</span></code></pre></td></tr></table></div></figure>


<p>As part of the migration, you could opt to remove old ruby version.  Then check the disk usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm disk-usage all
</span></code></pre></td></tr></table></div></figure>


<h2>Note</h2>

<p><a href="https://github.com/wayneeseguin/rvm">RVM</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[What Happened to FD 3 and 4 in MRI]]></title>
    <link href="http://www.zlu.me/blog/2012/11/08/what-happened-to-fd-3-and-4-in-mri/"/>
    <updated>2012-11-08T16:07:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/11/08/what-happened-to-fd-3-and-4-in-mri</id>
    <content type="html"><![CDATA[<p>I got curious when this happened:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">032</span> <span class="o">&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fileno</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>I know that file descriptors (FD) 0, 1, and 2 are assigned to STDIN, STDOUT, and STDERR.  I also know that FDs are assigned
in order.  So what happened to 3 and 4?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">015</span> <span class="o">&gt;</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">fileno</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">034</span> <span class="o">&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">for_fd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="no">ArgumentError</span><span class="p">:</span> <span class="no">The</span> <span class="n">given</span> <span class="n">fd</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">accessible</span> <span class="n">because</span> <span class="no">RubyVM</span> <span class="n">reserves</span> <span class="n">it</span>
</span><span class='line'>  <span class="n">from</span> <span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">34</span><span class="ss">:in</span> <span class="sb">`for_fd&#39;</span>
</span><span class='line'><span class="sb"> from (irb):34</span>
</span><span class='line'><span class="sb"> from /Users/zlu/.rvm/rubies/ruby-1.9.3-p286/bin/irb:16:in `</span><span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Evidently some ruby process is using it, but what process?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~<span class="nv">$ </span>lsof -d 3,4 | grep ruby
</span><span class='line'>ruby      4980  zlu    3     PIPE 0xffffff8029fa7860     16384           -&gt;0xffffff8029fa4370
</span><span class='line'>ruby      4980  zlu    4     PIPE 0xffffff8029fa4370     16384           -&gt;0xffffff8029fa7860
</span><span class='line'>
</span><span class='line'>COMMAND    PID  USER   FD    TYPE DEVICE                  SIZE/OFF   NODE NAME
</span></code></pre></td></tr></table></div></figure>


<p>And</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~<span class="nv">$ </span>ps -p 4980
</span><span class='line'>  PID TTY           TIME CMD
</span><span class='line'> 4980 ttys003    0:00.47 irb
</span></code></pre></td></tr></table></div></figure>


<p>So Ruby&rsquo;s RVM is using <em>pipes</em> with FD 3 and 4.  As far as what these pipes are used for, that&rsquo;ll be another discussion.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rolling Deployment]]></title>
    <link href="http://www.zlu.me/blog/2012/11/07/rolling-deployment/"/>
    <updated>2012-11-07T20:30:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/11/07/rolling-deployment</id>
    <content type="html"><![CDATA[<p>It is common to deploy new code to production several times a week (or even a day) in an agile shop.  How to make deployment
less intrusive to end user has becoming a larger issue.  If you simply use <code>cap deploy production</code>, some web requests will
time out hence hamper consumer experience.  Heroku supports maintenance mode, which can be turned on before a deployment.
User will see a maintenance page instead of unresponsive web page.  This is ok but not ideal.</p>

<p>Martin Fowler wrote about <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Blue Green Deployment</a>.  The canonical
form of this deployment strategy is to maintain two identical databases for each environment.  There is an issue of
dealing with missed transactions when deploying to one environment (stand-by) while the live environment is still taking
web requests.  There are a few ways to take care of this such as putting the live environment into read-only mode before the
cut-over.</p>

<p>For a small application (or a typical start-up scenario), having two database is a bit of over-kill and entails higher
operational costs.  With rolling deployment,  all the production web (application) servers share the same database.  To
reduce application downtime, only one web server will be taken out of the load balancer at a time.  This web server will then
be loaded with new code.  We can then run some quick automated tests (simple selenium tests for example) to ensure the build
is sane, against this web server.  If tests pass, we bring the node back into the load balancer.  We then repeat this process
for the next server.  If there are database changes that could potentially affect the state of the application and cause
inconsistency, then measure must be taken in the application to mitigate the problem through for example, back-fill.</p>

<h2>Setup</h2>

<p>A typical setup for a web app where multiple web servers (such as Unicorn) share the same database server.</p>

<pre>
                  |-> web server1 (red)   -|
load balancer --> |-> web server2 (blue)  -|---> database
                  |-> web server3 (green) -|
</pre>


<h2>Steps</h2>

<ul>
<li>Take the red web server out of load balancer</li>
<li>Deploy new code to red</li>
<li>Run deployment tests against red to ensure everything is sane</li>
<li>If tests pass, put red back to load balancer and continue to the next node, blue</li>
<li>If tests fail, roll back</li>
</ul>


<h2>Example</h2>

<p>In this example, I use Apache&rsquo;s <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy_balancer.html">mod_proxy_balancer</a>.
I use a typical Rails web server setup and <a href="https://github.com/capistrano/capistrano">Capistrano</a> for deployment.</p>

<figure class='code'><figcaption><span>In Rails&#8217; production.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server1.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:red</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server2.com&quot;</span><span class="p">,</span> <span class="ss">:group</span><span class="o">=&gt;</span> <span class="ss">:blue</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server3.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:green</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:apache</span><span class="p">,</span> <span class="s2">&quot;loadbalancer.com&quot;</span><span class="p">,</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>In Capistrano&#8217;s deploy.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">manage_node</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span><span class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">roles</span><span class="o">[</span><span class="ss">:apache</span><span class="o">]</span><span class="si">}</span><span class="s2">/balancer-manager&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response_body</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>  <span class="n">nonce</span> <span class="o">=</span> <span class="n">response_body</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/nonce=(.*)\&quot;/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">node</span> <span class="o">=</span> <span class="n">find_servers</span><span class="p">(</span><span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:group</span> <span class="o">=&gt;</span> <span class="n">group</span><span class="o">.</span><span class="n">to_sym</span><span class="p">})</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:w</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">node</span><span class="si">}</span><span class="s2">:8080&quot;</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="n">stage</span><span class="p">,</span> <span class="ss">:nonce</span> <span class="o">=&gt;</span> <span class="n">nonce</span><span class="p">,</span> <span class="ss">:dw</span> <span class="o">=&gt;</span> <span class="n">action</span><span class="p">}</span>
</span><span class='line'>  <span class="n">uri</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_www_form</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;200&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>mod_proxy_balancer has a balancer-manager GUI.  Admin is able to enable and disable node (web server) via a form.
manage_node method essentially submit the form to the balancer-manager.</p>

<p>To take red node out of the load balancer, simply define a task such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:enable</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">manage_mode</span><span class="p">(</span><span class="s2">&quot;Enable&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The value of group can be passed in as a command line option for Capistrano</p>

<h2>Other Considerations</h2>

<p>Why do I suggest running some basic tests as the acceptance criteria for rolling deployment?  I assume that the code
being deployed is well tested and passed CI/QA etc.  But there&rsquo;re all kinds of factors that can be different between test,
CI, and production environment.  Some library have different versions, VM images, or even the OS can be different.  I like
to use a Mac Mini for in-house CI (or Travis for open-source projects).  There&rsquo;s no guarantee that Travis or Mac Mini
can be kept up-to-date with production environment.  I could spin up a CI instance that replicates production but keeping
them in-sync still takes much effort.  There are also possibilities that integration test suites do not test views where
a simple route change could prevent user from successfully logging in.  By running a simple Selenium test to login and
perform one core function of the application, it gives me some level of assurance.</p>

<p>Capistrano supports deployment to a single server using HOSTS or HOSTFITLER command line options.  However, the load balancer
will keep sending requests to the server during deployment and server restart.</p>

<h2>Note</h2>

<p><a href="http://rdoc.info/github/capistrano/capistrano/master/Capistrano/Configuration/Servers">find_server API</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Encouraging Social Sharing in China]]></title>
    <link href="http://www.zlu.me/blog/2012/11/01/encourage-social-sharing-in-china/"/>
    <updated>2012-11-01T19:40:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/11/01/encourage-social-sharing-in-china</id>
    <content type="html"><![CDATA[<p>I recently spent a month in China, where access to Facebook, Twitter, and GooglePlus are blocked.  I&rsquo;ve always known
about the Great Firewall, but I never really thought about how it can affect content-sharing that I have grown used to over
the past years.</p>

<p>I have been using @octopress for blogging.  Octopress has built-in sharing function for Twitter, Facebook, and GooglePlus.
But none of it works in China.  To encourage social sharing, I add basic support for <a href="http://en.wikipedia.org/wiki/Sina_Weibo">Sina Weibo</a>.</p>

<ul>
<li>Weibo share button, on the bottom of the blog entry, allows users to easily share the url.  It also displays how many
times the entry has been shared.</li>
<li>A follow button (and follower count) on the side bar for Weibo.</li>
</ul>


<p>Here is the source code: <a href="https://github.com/zlu/octopress-sinaweibo">Octopress Sina Weibo</a></p>

<p>I hope more people will implement social-sharing for Chinese audience.</p>

<p>Here is the <a href="http://open.weibo.com">developer platform for Sina Weibo</a>, only in Chinese.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install and Create Rails 4.0 App]]></title>
    <link href="http://www.zlu.me/blog/2012/10/29/install-and-create-rails-4-dot-0-app/"/>
    <updated>2012-10-29T22:46:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/10/29/install-and-create-rails-4-dot-0-app</id>
    <content type="html"><![CDATA[<p>Rails 4.0 development has started a while back.  It was merged into Rails&#8217; master branch on Github in 2011.
As the writing of this blog entry, the stable version of Rails is 3.2.8.  Release candidate is at 3.2.9.rc1.
Because 4.0 is not yet official available, you have to jump through hoops to get a Rails 4 application up and running.</p>

<h2>Install Rails 4.0 gem</h2>

<p>Create this Gemfile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source 'http://rubygems.org'
</span><span class='line'>
</span><span class='line'>gem 'rails', :git =&gt; 'git://github.com/rails/rails.git'
</span><span class='line'>gem 'uglifier', '&gt;= 1.0.30'
</span><span class='line'>gem 'activerecord-deprecated_finders', :git =&gt; 'git://github.com/rails/activerecord-deprecated_finders.git'
</span><span class='line'>gem 'journey', :git =&gt; 'git://github.com/rails/journey.git'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>This Gemfile specifies the master branch of Rails, which contains 4.0 beta.</li>
<li>Gem activerecord-deprecated_finders is a dependency.</li>
<li>Gem journey, the Rails router, is also required.</li>
</ul>


<p>In the same directory of the Gemfile, issue <code>bundle install</code>.  This should install Rails 4.0.0.beta.
But running <code>gem list rails</code> won&rsquo;t show 4.0 being installed.  So do this instead:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~/projects/test$ bundle show rails
</span><span class='line'>/Users/zlu/.rvm/gems/ruby-1.9.3-p0/bundler/gems/rails-4e23c0ef341c</span></code></pre></td></tr></table></div></figure>


<p>The Rails executable is at:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails -v should show: Rails 4.0.0.beta</span></code></pre></td></tr></table></div></figure>


<p>Now you can use this version of rails to generate an app named foo.</p>

<h2>Create Rails 4.0 app</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails new foo</span></code></pre></td></tr></table></div></figure>


<p>This command  creates a typical rails app called foo and output an error about not being able to find Rails 4 gem, which
should not be a surprise.</p>

<p>You will edit foo/Gemfile to make <code>bundle install</code> work.</p>

<p>Add the two gems Rails depends on:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'journey', github: 'rails/journey'
</span><span class='line'>gem 'activerecord-deprecated_finders', github: 'rails/activerecord-deprecated_finders'</span></code></pre></td></tr></table></div></figure>


<p>Change the source definition for the following gems:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rails', '4.0.0.beta'
</span><span class='line'>gem 'sass-rails',   '~&gt; 4.0.0.beta'
</span><span class='line'>gem 'coffee-rails', '~&gt; 4.0.0.beta'
</span></code></pre></td></tr></table></div></figure>


<p>To</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rails', github: 'rails/rails'
</span><span class='line'>gem 'sass-rails', github: 'rails/sass-rails'
</span><span class='line'>gem 'coffee-rails', github: 'rails/coffee-rails'</span></code></pre></td></tr></table></div></figure>


<p>Now you should be <code>bundle install</code>, sit back and enjoy your new Rails 4.0 app.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Small Difference Between Mongoid and ActiveRecord Query Interface]]></title>
    <link href="http://www.zlu.me/blog/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface/"/>
    <updated>2012-10-16T21:29:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface</id>
    <content type="html"><![CDATA[<p>There are definitely some gotchas when switching from ActiveRecord to MongoDB (with Mongoid for example).  One of them
is how the IN operator in SQL is supported.</p>

<p>In ActiveRecord&rsquo;s Query Interface, we can do <code>MyModel.where(:id =&gt; [1,3,5])</code> and expect this SQL query to be generated:
<code>select * from MyModel where (MyModel.id IN (1,3,5))</code>.  Not true when it comes to Mongoid.</p>

<p>Mongo supports quite a few conditional operators such as &lt; (or $lt), $all, $in, etc.  So the above query needs to be constructed
as such:</p>

<p><code>MyModel.where(:id =&gt; {:$in =&gt; [1,3,5]})</code></p>

<p>Another example:</p>

<p><code>MyModel.where(:created_at =&gt; {:$gt =&gt; 2.days.ago})</code></p>

<p>This builds a query that returns instances of MyModel that were created in the past 2 days.</p>

<h1>TODO ActiveRecord#from &ndash; does not exist in Mongoid</h1>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Segmentation fault with Rails and JSON]]></title>
    <link href="http://www.zlu.me/blog/2012/10/16/segmentation-fault-with-rails-and-json/"/>
    <updated>2012-10-16T21:03:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/10/16/segmentation-fault-with-rails-and-json</id>
    <content type="html"><![CDATA[<p>After manually cleaning Ruby gems on my system, I got this error running <code>rails c</code> or <code>rails s</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects/foo <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>rails c
</span><span class='line'>/Users/zlu/.rvm/gems/ruby-1.9.3-p0/gems/json-1.7.5/lib/json/ext/parser.bundle: <span class="o">[</span>BUG<span class="o">]</span> Segmentation fault
</span><span class='line'>ruby 1.8.7 <span class="o">(</span>2012-02-08 patchlevel 358<span class="o">)</span> <span class="o">[</span>universal-darwin12.0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Abort <span class="nb">trap</span>: 6
</span></code></pre></td></tr></table></div></figure>


<p>It is very weird if you think about it.  The <code>ruby -v</code> shows that the system is using ruby version 1.9.3 managed by rvm.
But the error shows ruby 1.8.7!  It must be something I did with uninstalling versions of gems where executable requirements got messed up.</p>

<p>Instead of imploding rvm, here&rsquo;s what I did to correct the problem.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem list | cut -d<span class="s2">&quot; &quot;</span> -f1 | xargs gem uninstall -aIx
</span><span class='line'>gem install bundler
</span><span class='line'>bundle install
</span></code></pre></td></tr></table></div></figure>


<p>The first command uninstalls all the gems, including bundler.
After reinstalling bundler, you can run <code>bundle install</code>, assuming you are in a project directory where Gemfile.lock exists.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Accessing Facebook in Vietnam]]></title>
    <link href="http://www.zlu.me/blog/2012/08/30/accessing-facebook-in-vietnam/"/>
    <updated>2012-08-30T21:56:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/08/30/accessing-facebook-in-vietnam</id>
    <content type="html"><![CDATA[<p>I just traveled to Saigon, Vietnam.  After checking hotel, I logged onto Wifi and browsed to Facebook.
It won&rsquo;t load!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~$ ping www.facebook.com
</span><span class='line'>ping: cannot resolve www.facebook.com: Unknown host</span></code></pre></td></tr></table></div></figure>


<p>Hmm, that was strange.  A quick google search shows that some ISPs block Facebook due to government regulation.  But the
fix is quit easy.  All you need to do is to change your DNS server to Google DNS (8.8.8.8).</p>

<p>In OSX, open System Preferences &ndash;> Network &ndash;> DNS, add 8.8.8.8 to DNS servers (making sure it&rsquo;s the first in the list).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~$ ping www.facebook.com
</span><span class='line'>PING www.facebook.com (66.220.153.70): 56 data bytes
</span><span class='line'>64 bytes from 66.220.153.70: icmp_seq=0 ttl=238 time=269.573 ms</span></code></pre></td></tr></table></div></figure>


<p>Now you can browse Facebook again.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Uninstall Multiple Versions of Multiple Ruby Gems]]></title>
    <link href="http://www.zlu.me/blog/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem/"/>
    <updated>2012-07-31T10:13:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s say you have multiple versions of spree gems installed and want to get rid of the older versions.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba: gem list spree
</span><span class='line'>spree <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_api <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_auth <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_cmd <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_core <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_dash <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_promo <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_sample <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of doing this a bunch of times (for different gems and versions):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem uninstall spree -v 1.0.0
</span></code></pre></td></tr></table></div></figure>


<p>Do this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem uninstall spree<span class="o">{</span>,_api,_auth,_cmd,_core,_dash,_promo,_sample<span class="o">}</span> -v <span class="o">{</span>1.0.0, 1.0.0.rc2<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a feature of bash shell &ndash; <a href="http://www.gnu.org/software/bash/manual/html_node/Brace-Expansion.html#Brace-Expansion">brace expansion</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pretty Print JSON in Command Line]]></title>
    <link href="http://www.zlu.me/blog/2012/07/19/pretty-print-json-in-command-line/"/>
    <updated>2012-07-19T16:28:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/07/19/pretty-print-json-in-command-line</id>
    <content type="html"><![CDATA[<p>We often deal with viewing JSON documents in command line such as using curl against a server that returns JSON response.
It is hard to read.</p>

<p><a href="https://github.com/jmhodges/jsonpp/">jsonpp</a> comes to rescue.</p>

<p>On OS X, simply issue <code>brew install jsonpp</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>curl --user foo@bar.com:abc123 http://localhost:3000/users
</span><span class='line'><span class="o">[{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;500859f1827bc70b84000001&quot;</span>,<span class="s2">&quot;created_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;zlu@foo.bar&quot;</span>,<span class="s2">&quot;facebook_access_token&quot;</span>:null,<span class="s2">&quot;facebook_access_token_expiration&quot;</span>:null,<span class="s2">&quot;facebook_id&quot;</span>:null,<span class="s2">&quot;family_id&quot;</span>:null,<span class="s2">&quot;first_name&quot;</span>:<span class="s2">&quot;zhao&quot;</span>,<span class="s2">&quot;last_name&quot;</span>:<span class="s2">&quot;lu&quot;</span>,<span class="s2">&quot;phone_number&quot;</span>:null,<span class="s2">&quot;updated_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;500864a1827bc710a9000004&quot;</span>,<span class="s2">&quot;created_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;foo@bar.com&quot;</span>,<span class="s2">&quot;facebook_access_token&quot;</span>:null,<span class="s2">&quot;facebook_access_token_expiration&quot;</span>:null,<span class="s2">&quot;facebook_id&quot;</span>:null,<span class="s2">&quot;family_id&quot;</span>:null,<span class="s2">&quot;first_name&quot;</span>:<span class="s2">&quot;foo&quot;</span>,<span class="s2">&quot;last_name&quot;</span>:<span class="s2">&quot;bar&quot;</span>,<span class="s2">&quot;phone_number&quot;</span>:null,<span class="s2">&quot;updated_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span><span class="o">}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>After piping through jsonpp</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>curl --user foo@bar.com:abc123 http://localho000/users | jsonpp
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   604  100   604    0     0  45280      0 --:--:-- --:--:-- --:--:-- 60400
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;500859f1827bc70b84000001&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;created_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;zlu@foo.bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token_expiration&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;family_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;first_name&quot;</span>: <span class="s2">&quot;zhao&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;last_name&quot;</span>: <span class="s2">&quot;lu&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;phone_number&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;updated_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;500864a1827bc710a9000004&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;created_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;foo@bar.com&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token_expiration&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;family_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;first_name&quot;</span>: <span class="s2">&quot;foo&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;last_name&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;phone_number&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;updated_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Carrierwave with Fog for Amazon S3]]></title>
    <link href="http://www.zlu.me/blog/2012/07/17/testing-carrierwave-with-fog/"/>
    <updated>2012-07-17T21:10:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/07/17/testing-carrierwave-with-fog</id>
    <content type="html"><![CDATA[<p>Testing file upload using CarrierWave with Fog with S3 turns out to be difficult.</p>

<ul>
<li>CarrierWave/Fog need a non-empty file, otherwise the url to the S3 object will be nil and can&rsquo;t be tested.</li>
<li>Fog.mock! doesn&rsquo;t work out of box.  Some extra steps are needed to avoid uploading files to S3 when running tests.</li>
</ul>


<p>First, create config/fog_credentials.yml</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">aws_access_key_id</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-access-key-id&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">aws_secret_access_key</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-secret-access-key/&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-region&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, put this to your config/initializers/carrier_wave.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;config/fog_credentials.yml&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">fog_dir</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="p">?</span> <span class="s1">&#39;production-bucket&#39;</span> <span class="p">:</span> <span class="s1">&#39;dev-bucket&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">}</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>  <span class="o">=</span> <span class="n">fog_dir</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, put this into spec/support/fog_helper.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">mock!</span>
</span><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;config/fog_credentials.yml&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="no">Fog</span><span class="o">::</span><span class="no">Storage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:key</span> <span class="o">=&gt;</span> <span class="s1">&#39;dev-bucket&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note, the :key value <em>must</em> match whats defined for fog_dir (dev-bucket) in carrier_wave.rb</p>

<p>Suppose you want to test this class:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FileUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">storage</span> <span class="ss">:fog</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your rspec test can be something like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">TestFileUploader</span>
</span><span class='line'>  <span class="n">mount_uploader</span> <span class="ss">:file</span><span class="p">,</span> <span class="no">FileUploader</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">FileUploader</span> <span class="k">do</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">FakeFS</span><span class="o">::</span><span class="no">SpecHelpers</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;for non-production environment&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should upload video clip to dev-bucket on s3&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">.</span><span class="n">activate!</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:chmod</span><span class="p">)</span> <span class="c1">#this is needed or you will get an exception</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;test_file&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="c1"># this is required or uploader_test.file.url will be nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">uploader_test</span> <span class="o">=</span> <span class="no">TestFileUploader</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;test_file&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span> <span class="sr">/.*\/dev-bucket.*/</span> <span class="c1">#test to make sure that it is not production-bucket</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">.</span><span class="n">deactivate!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the test is complete.  It uses fakefs to generate a fake file which is non-empty.  Fog will pretent to upload the file
using the FileUploader under test.  The upload url is the subject under test.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My Current Emacs]]></title>
    <link href="http://www.zlu.me/blog/2012/05/18/my-current-emacs/"/>
    <updated>2012-05-18T19:49:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/05/18/my-current-emacs</id>
    <content type="html"><![CDATA[<pre>
Emacs with Sidebar enabled.
Emacs shows: file size, (row, col), file mode (Erlang), time, CPU load, [Battery]
Emacs uses Tango dark theme.
Emacs with Rinari enabled.
</pre>


<p><a href="https://gist.github.com/2727854">.emacs</a></p>

<p><img src="http://f.cl.ly/items/152h3x2t0N440t2Q2D0Q/Screen%20Shot%202012-05-18%20at%207.51.27%20PM.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TDD by Jim Weirich]]></title>
    <link href="http://www.zlu.me/blog/2012/05/13/tdd-by-jim-weirich/"/>
    <updated>2012-05-13T18:28:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/05/13/tdd-by-jim-weirich</id>
    <content type="html"><![CDATA[<p>I invited Jim Weirich to give us a week-long training on TDD/BDD/Agile.  Here&rsquo;re the raw notes.</p>

<p>The way of Testivus</p>

<p>Code driven from tests are more composable</p>

<p>RSpec &ndash; Focus on Behavior</p>

<p>Avoid testing state</p>

<p>As a client, I don&rsquo;t care about internal member variables or implementations, I only care about the result.</p>

<p>Reveal our intentions</p>

<p>Focus on the design</p>

<p>Forget unit, describe context</p>

<p>context is an alias to describe</p>

<p>describe/context is equivalent to creating a class of the object and behavior being described/contexted.
  class DescribeRing . . end
  class ContextWhenEmpty . . end
Also class inherits from top-level class
Why helper methods should be in various levels (nesting) of tests</p>

<p>predicate &ndash; any method ends with ?</p>

<p>be/equal => object identity</p>

<p>eql or == is structural equality</p>

<p>let(:symbol) { } creates a named method identified by :symbol.  When referred, the block will be executed exactly once.</p>

<p>Implicit subject</p>

<p>its(:symbol) {  should be_true }
specify is a &lsquo;kind of&rsquo; its</p>

<p>Given/When/Then</p>

<p>rspec differentiate mocks and stubs.  stubs doesn&rsquo;t have to be called while mocks have to be at least once.
constraints are should_recieve, once, etc.
actions are and_return</p>

<p>stubs don&rsquo;t care how many times you call it or parameters passed in</p>

<p>Flatten the cost of change in software engineering &ndash; how?
  The key is to increase feedback</p>

<p>YAGNI &ndash; You ain&rsquo;t going to need it #Agile &ndash; No speculative coding!</p>

<p>What is simple?
  Passes all the tests
  Reveals the intention of the developer
  No Duplication
  Fewest huber of classes or methods</p>

<p>Collective Ownership</p>

<p>Sustainable Pace (40-hr work week in America)</p>

<p>Initial Importance
  Must/Should/Could/Won&rsquo;t
  Do high value and high risk stories first</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Running Wireshark on Mountain Lion]]></title>
    <link href="http://www.zlu.me/blog/2012/02/28/running-wireshark-on-mountain-lion/"/>
    <updated>2012-02-28T09:06:00+08:00</updated>
    <id>http://www.zlu.me/blog/2012/02/28/running-wireshark-on-mountain-lion</id>
    <content type="html"><![CDATA[<p>X11 has been removed from Mountain Lion and you first need to install XQuartz</p>
]]></content>
  </entry>
  
</feed>
