
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@zlu</title>
  <meta name="author" content="Zhao Lu">

  
  <meta name="description" content="It is common to deploy new code to production several times a week (or even a day) in an agile shop. How to make deployment
less intrusive to end &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.zlu.me/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="@zlu" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7031506-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">mob</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">@zlu</a></h1>
  
    <h2>foo bar</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.zlu.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/11/07/rolling-deployment/">Rolling Deployment</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-07T20:30:00-08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/07/rolling-deployment/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is common to deploy new code to production several times a week (or even a day) in an agile shop.  How to make deployment
less intrusive to end user has becoming a larger issue.  If you simply use <code>cap deploy production</code>, some web requests will
time out hence hamper consumer experience.  Heroku supports maintenance mode, which can be turned on before a deployment.
User will see a maintenance page instead of unresponsive web page.  This is ok but not ideal.</p>

<p>Martin Fowler wrote about <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Blue Green Deployment</a>.  The canonical
form of this deployment strategy is to maintain two identical databases for each environment.  There is an issue of
dealing with missed transactions when deploying to one environment (stand-by) while the live environment is still taking
web requests.  There are a few ways to take care of this such as putting the live environment into read-only mode before the
cut-over.</p>

<p>For a small application (or a typical start-up scenario), having two database is a bit of over-kill and entails higher
operational costs.  With rolling deployment,  all the production web (application) servers share the same database.  To
reduce application downtime, only one web server will be taken out of the load balancer at a time.  This web server will then
be loaded with new code.  We can then run some quick automated tests (simple selenium tests for example) to ensure the build
is sane, against this web server.  If tests pass, we bring the node back into the load balancer.  We then repeat this process
for the next server.  If there are database changes that could potentially affect the state of the application and cause
inconsistency, then measure must be taken in the application to mitigate the problem through for example, back-fill.</p>

<h2>Setup</h2>

<p>A typical setup for a web app where multiple web servers (such as Unicorn) share the same database server.</p>

<pre>
                  |-> web server1 (red)   -|
load balancer --> |-> web server2 (blue)  -|---> database
                  |-> web server3 (green) -|
</pre>


<h2>Steps</h2>

<ul>
<li>Take the red web server out of load balancer</li>
<li>Deploy new code to red</li>
<li>Run deployment tests against red to ensure everything is sane</li>
<li>If tests pass, put red back to load balancer and continue to the next node, blue</li>
<li>If tests fail, roll back</li>
</ul>


<h2>Example</h2>

<p>In this example, I use Apache&#8217;s <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy_balancer.html">mod_proxy_balancer</a>.
I use a typical Rails web server setup and <a href="https://github.com/capistrano/capistrano">Capistrano</a> for deployment.</p>

<p>In production.rb, define the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server1.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:red</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server2.com&quot;</span><span class="p">,</span> <span class="ss">:group</span><span class="o">=&gt;</span> <span class="ss">:blue</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server3.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:green</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:apache</span><span class="p">,</span> <span class="s2">&quot;loadbalancer.com&quot;</span><span class="p">,</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Capistrano&#8217;s deploy.rb, define the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">manage_node</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span><span class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">roles</span><span class="o">[</span><span class="ss">:apache</span><span class="o">]</span><span class="si">}</span><span class="s2">/balancer-manager&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response_body</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>  <span class="n">nonce</span> <span class="o">=</span> <span class="n">response_body</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/nonce=(.*)\&quot;/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">node</span> <span class="o">=</span> <span class="n">find_servers</span><span class="p">(</span><span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:group</span> <span class="o">=&gt;</span> <span class="n">group</span><span class="o">.</span><span class="n">to_sym</span><span class="p">})</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:w</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">node</span><span class="si">}</span><span class="s2">:8080&quot;</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="n">stage</span><span class="p">,</span> <span class="ss">:nonce</span> <span class="o">=&gt;</span> <span class="n">nonce</span><span class="p">,</span> <span class="ss">:dw</span> <span class="o">=&gt;</span> <span class="n">action</span><span class="p">}</span>
</span><span class='line'>  <span class="n">uri</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_www_form</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;200&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>mod_proxy_balancer has a balancer-manager GUI.  Admin is able to enable and disable node (web server) via a form.
manage_node method essentially submit the form to the balancer-manager.</p>

<p>To take red node out of the load balancer, simply define a task such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:enable</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">manage_mode</span><span class="p">(</span><span class="s2">&quot;Enable&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The value of group can be passed in as a command line option for Capistrano</p>

<h2>Other Considerations</h2>

<p>Why do I suggest running some basic tests as the acceptance criteria for rolling deployment?  I assume that the code
being deployed is well tested and passed CI/QA etc.  But there&#8217;re all kinds of factors that can be different between test,
CI, and production environment.  Some library have different versions, VM images, or even the OS can be different.  I like
to use a Mac Mini for in-house CI (or Travis for open-source projects).  There&#8217;s no guarantee that Travis or Mac Mini
can be kept up-to-date with production environment.  I could spin up a CI instance that replicates production but keeping
them in-sync still takes much effort.  There are also possibilities that integration test suites do not test views where
a simple route change could prevent user from successfully logging in.  By running a simple Selenium test to login and
perform one core function of the application, it gives me some level of assurance to continue the deployment.</p>

<p>Capistrano supports deployment to a single server using HOSTS or HOSTFITLER command line options.  However, the load balancer
will keep sending requests to the server when deployment and restart is happening.</p>

<h2>Note</h2>

<p><a href="http://rdoc.info/github/capistrano/capistrano/master/Capistrano/Configuration/Servers">find_server API</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/11/01/encourage-social-sharing-in-china/">Encourage Social Sharing in China</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-01T19:40:00-07:00" pubdate data-updated="true">Nov 1<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/11/01/encourage-social-sharing-in-china/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently spent a month in China, where access to Facebook, Twitter, and GooglePlus are blocked.  I&#8217;ve always known
about the Great Firewall, but I never really thought about how it can affect content-sharing that I have grown used to over
the past years.</p>

<p>I have been using @octopress for blogging.  Octopress has built-in sharing function for Twitter, Facebook, and GooglePlus.
But none of it works in China.  To encourage social sharing, I add basic support for <a href="http://en.wikipedia.org/wiki/Sina_Weibo">Sina Weibo</a>.</p>

<ul>
<li>Weibo share button, on the bottom of the blog entry, allows users to easily share the url.  It also displays how many
times the entry has been shared.</li>
<li>A follow button (and follower count) on the side bar for Weibo.</li>
</ul>


<p>Here is the source code: <a href="https://github.com/zlu/octopress-sinaweibo">Octopress Sina Weibo</a></p>

<p>I hope more people will implement social-sharing for Chinese audience.</p>

<p>Here is the <a href="http://open.weibo.com">developer platform for Sina Weibo</a>, only in Chinese.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/10/29/install-and-create-rails-4-dot-0-app/">Install and Create Rails 4.0 App</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-10-29T22:46:00-07:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/29/install-and-create-rails-4-dot-0-app/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Rails 4.0 development has started a while back.  It was merged into Rails&#8217; master branch on Github in 2011.
As the writing of this blog entry, the stable version of Rails is 3.2.8.  Release candidate is at 3.2.9.rc1.
Because 4.0 is not yet official available, you have to jump through hoops to get a Rails 4 application up and running.</p>

<h2>Install Rails 4.0 gem</h2>

<p>Create this Gemfile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source 'http://rubygems.org'
</span><span class='line'>
</span><span class='line'>gem 'rails', :git =&gt; 'git://github.com/rails/rails.git'
</span><span class='line'>gem 'uglifier', '&gt;= 1.0.30'
</span><span class='line'>gem 'activerecord-deprecated_finders', :git =&gt; 'git://github.com/rails/activerecord-deprecated_finders.git'
</span><span class='line'>gem 'journey', :git =&gt; 'git://github.com/rails/journey.git'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>This Gemfile specifies the master branch of Rails, which contains 4.0 beta.</li>
<li>Gem activerecord-deprecated_finders is a dependency.</li>
<li>Gem journey, the Rails router, is also required.</li>
</ul>


<p>In the same directory of the Gemfile, issue <code>bundle install</code>.  This should install Rails 4.0.0.beta.
But running <code>gem list rails</code> won&#8217;t show 4.0 being installed.  So do this instead:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~/projects/test$ bundle show rails
</span><span class='line'>/Users/zlu/.rvm/gems/ruby-1.9.3-p0/bundler/gems/rails-4e23c0ef341c</span></code></pre></td></tr></table></div></figure>


<p>The Rails executable is at:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails -v should show: Rails 4.0.0.beta</span></code></pre></td></tr></table></div></figure>


<p>Now you can use this version of rails to generate an app named foo.</p>

<h2>Create Rails 4.0 app</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`bundle show rails`/railties/bin/rails new foo</span></code></pre></td></tr></table></div></figure>


<p>This command  creates a typical rails app called foo and output an error about not being able to find Rails 4 gem, which
should not be a surprise.</p>

<p>You will edit foo/Gemfile to make <code>bundle install</code> work.</p>

<p>Add the two gems Rails depends on:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'journey', github: 'rails/journey'
</span><span class='line'>gem 'activerecord-deprecated_finders', github: 'rails/activerecord-deprecated_finders'</span></code></pre></td></tr></table></div></figure>


<p>Change the source definition for the following gems:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rails', '4.0.0.beta'
</span><span class='line'>gem 'sass-rails',   '~&gt; 4.0.0.beta'
</span><span class='line'>gem 'coffee-rails', '~&gt; 4.0.0.beta'
</span></code></pre></td></tr></table></div></figure>


<p>To</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rails', github: 'rails/rails'
</span><span class='line'>gem 'sass-rails', github: 'rails/sass-rails'
</span><span class='line'>gem 'coffee-rails', github: 'rails/coffee-rails'</span></code></pre></td></tr></table></div></figure>


<p>Now you should be <code>bundle install</code>, sit back and enjoy your new Rails 4.0 app.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface/">A Small Difference Between Mongoid and ActiveRecord Query Interface</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-10-16T21:29:00-07:00" pubdate data-updated="true">Oct 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There are definitely some gotchas when switching from ActiveRecord to MongoDB (with Mongoid for example).  One of them
is how the IN operator in SQL is supported.</p>

<p>In ActiveRecord&#8217;s Query Interface, we can do <code>MyModel.where(:id =&gt; [1,3,5])</code> and expect this SQL query to be generated:
<code>select * from MyModel where (MyModel.id IN (1,3,5))</code>.  Not true when it comes to Mongoid.</p>

<p>Mongo supports quite a few conditional operators such as &lt; (or $lt), $all, $in, etc.  So the above query needs to be constructed
as such:</p>

<p><code>MyModel.where(:id =&gt; {:$in =&gt; [1,3,5]})</code></p>

<p>Another example:</p>

<p><code>MyModel.where(:created_at =&gt; {:$gt =&gt; 2.days.ago})</code></p>

<p>This builds a query that returns instances of MyModel that were created in the past 2 days.</p>

<h1>TODO ActiveRecord#from - does not exist in Mongoid</h1>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/10/16/segmentation-fault-with-rails-and-json/">Segmentation Fault With Rails and JSON</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-10-16T21:03:00-07:00" pubdate data-updated="true">Oct 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/16/segmentation-fault-with-rails-and-json/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After manually cleaning Ruby gems on my system, I got this error running <code>rails c</code> or <code>rails s</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects/foo <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>rails c
</span><span class='line'>/Users/zlu/.rvm/gems/ruby-1.9.3-p0/gems/json-1.7.5/lib/json/ext/parser.bundle: <span class="o">[</span>BUG<span class="o">]</span> Segmentation fault
</span><span class='line'>ruby 1.8.7 <span class="o">(</span>2012-02-08 patchlevel 358<span class="o">)</span> <span class="o">[</span>universal-darwin12.0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Abort <span class="nb">trap</span>: 6
</span></code></pre></td></tr></table></div></figure>


<p>It is very weird if you think about it.  The <code>ruby -v</code> shows that the system is using ruby version 1.9.3 managed by rvm.
But the error shows ruby 1.8.7!  It must be something I did with uninstalling versions of gems where executable requirements got messed up.</p>

<p>Instead of imploding rvm, here&#8217;s what I did to correct the problem.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem list | cut -d<span class="s2">&quot; &quot;</span> -f1 | xargs gem uninstall -aIx
</span><span class='line'>gem install bundler
</span><span class='line'>bundle install
</span></code></pre></td></tr></table></div></figure>


<p>The first command uninstalls all the gems, including bundler.
After reinstalling bundler, you can run <code>bundle install</code>, assuming you are in a project directory where Gemfile.lock exists.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/08/30/accessing-facebook-in-vietnam/">Accessing Facebook in Vietnam</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-08-30T21:56:00-07:00" pubdate data-updated="true">Aug 30<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/30/accessing-facebook-in-vietnam/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just traveled to Saigon, Vietnam.  After checking hotel, I logged onto Wifi and browsed to Facebook.
It won&#8217;t load!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~$ ping www.facebook.com
</span><span class='line'>ping: cannot resolve www.facebook.com: Unknown host</span></code></pre></td></tr></table></div></figure>


<p>Hmm, that was strange.  A quick google search shows that some ISPs block Facebook due to government regulation.  But the
fix is quit easy.  All you need to do is to change your DNS server to Google DNS (8.8.8.8).</p>

<p>In OSX, open System Preferences -> Network -> DNS, add 8.8.8.8 to DNS servers (making sure it&#8217;s the first in the list).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zlu@zlu-mba:~$ ping www.facebook.com
</span><span class='line'>PING www.facebook.com (66.220.153.70): 56 data bytes
</span><span class='line'>64 bytes from 66.220.153.70: icmp_seq=0 ttl=238 time=269.573 ms</span></code></pre></td></tr></table></div></figure>


<p>Now you can browse Facebook again.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem/">Uninstall Multiple Versions of Multiple Ruby Gems</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-07-31T10:13:00-07:00" pubdate data-updated="true">Jul 31<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&#8217;s say you have multiple versions of spree gems installed and want to get rid of the older versions.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba: gem list spree
</span><span class='line'>spree <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_api <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_auth <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_cmd <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_core <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_dash <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_promo <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span><span class='line'>spree_sample <span class="o">(</span>1.1.3, 1.0.0, 1.0.0.rc2<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of doing this a bunch of times (for different gems and versions):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem uninstall spree -v 1.0.0
</span></code></pre></td></tr></table></div></figure>


<p>Do this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem uninstall spree<span class="o">{</span>,_api,_auth,_cmd,_core,_dash,_promo,_sample<span class="o">}</span> -v <span class="o">{</span>1.0.0, 1.0.0.rc2<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a feature of bash shell - <a href="http://www.gnu.org/software/bash/manual/html_node/Brace-Expansion.html#Brace-Expansion">brace expansion</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/07/19/pretty-print-json-in-command-line/">Pretty Print JSON in Command Line</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-07-19T16:28:00-07:00" pubdate data-updated="true">Jul 19<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/19/pretty-print-json-in-command-line/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We often deal with viewing JSON documents in command line such as using curl against a server that returns JSON response.
It is hard to read.</p>

<p><a href="https://github.com/jmhodges/jsonpp/">jsonpp</a> comes to rescue.</p>

<p>On OS X, simply issue <code>brew install jsonpp</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>curl --user foo@bar.com:abc123 http://localhost:3000/users
</span><span class='line'><span class="o">[{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;500859f1827bc70b84000001&quot;</span>,<span class="s2">&quot;created_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;zlu@foo.bar&quot;</span>,<span class="s2">&quot;facebook_access_token&quot;</span>:null,<span class="s2">&quot;facebook_access_token_expiration&quot;</span>:null,<span class="s2">&quot;facebook_id&quot;</span>:null,<span class="s2">&quot;family_id&quot;</span>:null,<span class="s2">&quot;first_name&quot;</span>:<span class="s2">&quot;zhao&quot;</span>,<span class="s2">&quot;last_name&quot;</span>:<span class="s2">&quot;lu&quot;</span>,<span class="s2">&quot;phone_number&quot;</span>:null,<span class="s2">&quot;updated_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;500864a1827bc710a9000004&quot;</span>,<span class="s2">&quot;created_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;foo@bar.com&quot;</span>,<span class="s2">&quot;facebook_access_token&quot;</span>:null,<span class="s2">&quot;facebook_access_token_expiration&quot;</span>:null,<span class="s2">&quot;facebook_id&quot;</span>:null,<span class="s2">&quot;family_id&quot;</span>:null,<span class="s2">&quot;first_name&quot;</span>:<span class="s2">&quot;foo&quot;</span>,<span class="s2">&quot;last_name&quot;</span>:<span class="s2">&quot;bar&quot;</span>,<span class="s2">&quot;phone_number&quot;</span>:null,<span class="s2">&quot;updated_at&quot;</span>:<span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span><span class="o">}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>After piping through jsonpp</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~/projects <span class="o">(</span>master *<span class="o">)</span><span class="nv">$ </span>curl --user foo@bar.com:abc123 http://localho000/users | jsonpp
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100   604  100   604    0     0  45280      0 --:--:-- --:--:-- --:--:-- 60400
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;500859f1827bc70b84000001&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;created_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;zlu@foo.bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token_expiration&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;family_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;first_name&quot;</span>: <span class="s2">&quot;zhao&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;last_name&quot;</span>: <span class="s2">&quot;lu&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;phone_number&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;updated_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:03:22-07:00&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;500864a1827bc710a9000004&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;created_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;foo@bar.com&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_access_token_expiration&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;facebook_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;family_id&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;first_name&quot;</span>: <span class="s2">&quot;foo&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;last_name&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;phone_number&quot;</span>: null,
</span><span class='line'>    <span class="s2">&quot;updated_at&quot;</span>: <span class="s2">&quot;2012-07-19T12:48:49-07:00&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/07/17/testing-carrierwave-with-fog/">Testing Carrierwave With Fog for Amazon S3</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-07-17T21:10:00-07:00" pubdate data-updated="true">Jul 17<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/17/testing-carrierwave-with-fog/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Testing file upload using CarrierWave with Fog with S3 turns out to be difficult.</p>

<ul>
<li>CarrierWave/Fog need a non-empty file, otherwise the url to the S3 object will be nil and can&#8217;t be tested.</li>
<li>Fog.mock! doesn&#8217;t work out of box.  Some extra steps are needed to avoid uploading files to S3 when running tests.</li>
</ul>


<p>First, create config/fog_credentials.yml</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">aws_access_key_id</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-access-key-id&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">aws_secret_access_key</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-secret-access-key/&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="s">&#39;your-aws-region&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, put this to your config/initializers/carrier_wave.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;config/fog_credentials.yml&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">fog_dir</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="p">?</span> <span class="s1">&#39;production-bucket&#39;</span> <span class="p">:</span> <span class="s1">&#39;dev-bucket&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_credentials</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">}</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span>  <span class="o">=</span> <span class="n">fog_dir</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, put this into spec/support/fog_helper.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">mock!</span>
</span><span class='line'><span class="no">Fog</span><span class="o">.</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;config/fog_credentials.yml&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="no">Fog</span><span class="o">::</span><span class="no">Storage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="s1">&#39;AWS&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:key</span> <span class="o">=&gt;</span> <span class="s1">&#39;dev-bucket&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note, the :key value <em>must</em> match whats defined for fog_dir (dev-bucket) in carrier_wave.rb</p>

<p>Suppose you want to test this class:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FileUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">storage</span> <span class="ss">:fog</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your rspec test can be something like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">TestFileUploader</span>
</span><span class='line'>  <span class="n">mount_uploader</span> <span class="ss">:file</span><span class="p">,</span> <span class="no">FileUploader</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">FileUploader</span> <span class="k">do</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">FakeFS</span><span class="o">::</span><span class="no">SpecHelpers</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;for non-production environment&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should upload video clip to dev-bucket on s3&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">.</span><span class="n">activate!</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:chmod</span><span class="p">)</span> <span class="c1">#this is needed or you will get an exception</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;test_file&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="c1"># this is required or uploader_test.file.url will be nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">uploader_test</span> <span class="o">=</span> <span class="no">TestFileUploader</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;test_file&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>      <span class="n">uploader_test</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">should</span> <span class="n">match</span> <span class="sr">/.*\/dev-bucket.*/</span> <span class="c1">#test to make sure that it is not production-bucket</span>
</span><span class='line'>      <span class="no">FakeFS</span><span class="o">.</span><span class="n">deactivate!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the test is complete.  It uses fakefs to generate a fake file which is non-empty.  Fog will pretent to upload the file
using the FileUploader under test.  The upload url is the subject under test.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/05/18/my-current-emacs/">My Current Emacs</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-05-18T19:49:00-07:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/18/my-current-emacs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><pre>
Emacs with Sidebar enabled.
Emacs shows: file size, (row, col), file mode (Erlang), time, CPU load, [Battery]
Emacs uses Tango dark theme.
Emacs with Rinari enabled.
</pre>


<p><a href="https://gist.github.com/2727854">.emacs</a></p>

<p><img src="http://f.cl.ly/items/152h3x2t0N440t2Q2D0Q/Screen%20Shot%202012-05-18%20at%207.51.27%20PM.png"></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
	<h1>Flickr</h1>
	<div class="flickr">
		<script type="text/javascript" src="http://www.flickr.com/badge_code_v2.gne?count=4&display=random&size=t&layout=v&source=user&user=76883175@N03"></script>
	</div>
</section><section>
    <h1>About Me</h1>
    Curious minds, yogi, cyclist, and outdoor enthusiast.<br/>
    <a href="http://www.linkedin.com/in/zhaolu">LinkedIn</a> |
    <a href="http://zlu.github.com">Projects</a> |
    <a href="https://github.com/zlu/wiki/wiki/_pages">Wiki</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/07/rolling-deployment/">Rolling Deployment</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/01/encourage-social-sharing-in-china/">Encourage Social Sharing in China</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/29/install-and-create-rails-4-dot-0-app/">Install and Create Rails 4.0 App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface/">A Small Difference Between Mongoid and ActiveRecord Query Interface</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/16/segmentation-fault-with-rails-and-json/">Segmentation fault with Rails and JSON</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/zlu">@zlu</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zlu',
            count: 1,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("zlu", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/zlu" class="twitter-follow-button" data-show-count="true">Follow @zlu</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/114923193968506814109?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>


<html xmlns:wb=http://open.weibo.com/wb>
<head>
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
</head>


<section>
    <wb:follow-button uid="2091903003" type="gray_2" width="136" height="24" ></wb:follow-button>
</section>


</html>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Zhao Lu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zlu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






</body>
</html>
