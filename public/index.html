
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>吕钊</title>
  <meta name="author" content="Zhao Lu">

  
  <meta name="description" content="Spotify Play List I added my yoga playlist on Spotify on the sidebar, below recent posts.
I changed default theme to white and used minimum width 250 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.zlu.me/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="吕钊" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7031506-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">@zlu</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">吕钊</a></h1>
  
    <h2>A personal blog of Zhao Lü</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.zlu.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/09/29/site-updates/">Site Updates</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-09-29T22:31:00+08:00" pubdate data-updated="true">Sep 29<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/29/site-updates/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4><a href="https://developer.spotify.com/technologies/spotify-play-button/">Spotify Play List</a></h4>

<p>I added my yoga playlist on <a href="http://www.spotify">Spotify</a> on the sidebar, below recent posts.
I changed default theme to white and used minimum width 250 for the widget.
Here is the <a href="https://github.com/zlu/octopress/commit/6b8ff500d01109b390ec1e1f79502d1fc4a1adbe">first commit</a>.</p>

<p>See <a href="https://developer.spotify.com/technologies/spotify-play-button/documentation/">documentation</a> for more customization options.</p>

<h4>Change Log</h4>

<p>Based on this <a href="https://gist.github.com/alx/730347">gist</a>, I added a change log (a Jekyll plugin) for this blog, just for fun.  The change log is on the side bar under tweets.  It displays the last 10 commits.</p>

<p>Here is a relevant <a href="https://github.com/zlu/octopress/commit/2dc9ad5cade9cea359a3d8bd39752c90fb000f91">commit</a>.</p>

<h4>Favicon</h4>

<p>New favicon: <img src="http://www.zlu.me/favicon.ico" alt="zlu blog favicon" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/09/27/quicksurveyofrailscms/">Quick Survey of Rails CMS</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-09-27T21:37:00+08:00" pubdate data-updated="true">Sep 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/27/quicksurveyofrailscms/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Update 1</strong> (September 29, 2013) &ndash; Added references and more CMS.<br/>
<strong>Update 2</strong> (September 30, 2013) &ndash; ComfortableMexicanSofa does <em>not</em> use Liquid Template, as GBH has pointed out in the comment.</p>

<p>Selecting a Content Management System (CMS) is never an easy task.  I have recently spent a good amount of time tinkering with different implementations and would like to share my learnings here.</p>

<p>There are many solutions on the market so you should solidify your requirements to help you narrow down the choices.  This CMS will be used for <a href="https://foryogi.com">ForYogi</a> with the following requirements:</p>

<ul>
<li>Admin can add tutorials on how to use the site for teachers/studios/users.</li>
<li>Admin can add articles for yoga-related topics into a knowledge base.  Topics can be as simple as definition of  <em>yogi</em> or Sanskrit terminologies such as <em>asana</em>.</li>
<li>Admin can add help content which can be accessed by the application and displayed in various parts of the app.</li>
<li>Admin can add FAQs.</li>
<li>Users can search contents in Knowledge Base.</li>
<li>Admin can customize layout and css style.</li>
<li>Drop-in support for existing Rails4 (Ruby 2) project.</li>
<li>Inexpensive &ndash; Some hosted solution can get pricey depending on storage and other factors.</li>
</ul>


<h4>General Impression</h4>

<p> CMS is often used by developers to create customizable mostly static websites for clients.  Most of the Rails CMS gems have over the years, <a href="http://guides.rubyonrails.org/engines.html%E2%80%8E">enginfied</a>, providing drop-in support for existing Rails apps.</p>

<p><strong><a href="http://refinerycms.com">RefineryCMS</a></strong></p>

<p>There are <a href="http://railscasts.com/episodes/332-refinery-cms-basics">free</a> and <a href="http://railscasts.com/episodes/333-extending-refinery-cms">pro</a> episodes of it on RailsCasts.com.  I don&rsquo;t have a pro-account so I only examined the free content.  My impression is it&rsquo;s easy to set it ground-up with customized style.  This CMS has been around for a long time and has a good community build around it.  There are two factors against me choosing it though:</p>

<ul>
<li>At the time of writing, its Rails4 support is <a href="https://github.com/refinery/refinerycms/commit/d9e7d4dfda3256ece0b527da269a1f2643a9afc2">work in progress</a>.</li>
<li>Integrating it with an existing application using devise is quite involved according to this <a href="http://refinerycms.com/guides/with-an-existing-rails-31-devise-app">article</a>.</li>
</ul>


<p><strong><a href="http://locomotivecms.com">LocomotivesCMS</a></strong></p>

<p>This one has a nicely styled site (compare to some other CMS) but has a few things that concerns me:</p>

<ul>
<li>It requires MongoDB.  It is not a big deal. I&rsquo;m not using Mongo in my current setup.  I can get a small setup using Heroku add-on but I&rsquo;d probably have to pay to get a storage bump-up in the near future.</li>
<li>Weak <a href="http://doc.locomotivecms.com">documentation</a>.  I looked through the content and found documentation is quite superficial and lacking depth.  It is understandable as they offer a hosting solution.</li>
<li>The <a href="https://github.com/locomotivecms/engine/issues/746">issue</a> on Rails4 support concerns me the most:

<blockquote><p>Probably by the end of the year. However, It could happen sooner depending on how successful would be our hosting solution…Long story short, we need financial support to handle the next big version of the engine which will include a new UI.</p></blockquote></li>
</ul>


<p>As there is no guarantee for a rather future release of Rails4 support (at least not in their current roadmap), I pass.   <br/>
<strong><a href="http://alchemy-cms.com">AlchemyCMS</a></strong></p>

<p>I first learned about this CMS through the comments on the free RailsCasts episode.  They argued about why they are better than refineryCMS.  I liked their idea of storing pure content, not css style and layouts in database.  It&rsquo;ll only make migration to other systems easier.  I also noticed that they have a <a href="https://github.com/magiclabs/alchemy_cms/tree/3.0-dev">3.0-dev branch</a> supporting Rails4 with this <a href="fe94bedc761484940071129277970a6cd65fba10">sha</a>.  Installation has proved to be hard as there are a few conflict in various gems (if you use activeadmin and devise).  I was able to install it after some struggle.  However, I encountered problems running it (devise login, actions_cache).  It was just wasting more time than I wanted at this point.</p>

<p><strong><a href="">BrowserCMS</a></strong></p>

<p>The first problem I had is jquery-rails version being too low even for their <a href="https://github.com/browsermedia/browsercms">Rails 4 master branch</a> for which <a href="https://github.com/peakpg">peakpg</a> opened <a href="https://github.com/browsermedia/browsercms/issues/625">an issue</a>.  After fixing that in my own fork, I continue running into other problems.  Basically the Rails4 support is not quite ready yet.</p>

<p><strong><a href="">ComfortableMexicanSofa</a></strong></p>

<p>This cleverly named gem is lesser popular than the other gems I&rsquo;ve looked at based on the number of watches and forks on github.  However, it is the only one that worked out-of-box with an existing Rails4 app with devise authentication.  The documentation explains the theory well but lacks examples.  I suggest watching the RailsCasts <a href="http://railscasts.com/episodes/118%E2%80%8E">free episode</a> on <a href="http://liquidmarkup.org/%E2%80%8E">Liquid template</a> and really understand <a href="https://github.com/comfy/comfortable-mexican-sofa/wiki/Tags">tags</a> and how to apply partials/helpers.</p>

<p>Here is how to create a simple navigation for all the pages.  According to the <a href="https://github.com/comfy/comfortable-mexican-sofa/wiki/Creating-navigation-from-pages">guide</a>, you need to add something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% @cms_site.pages.root.children.published.each </span><span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= link_to(page.label, page.full_path) %&gt;</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But where do you add it?  I tried to create a new partial _kb.html.erb under app/views/layouts and got a no partial found error.  It is looking for cms_content and application directories for partials.  So I created app/views/cms_content directory and moved the partial there.  This kind/level of details should, ideally, be in the guide.
You can then invoke this partial inside of a layout:</p>

<pre><code>{{ cms:partial:kb }}
</code></pre>

<p>Once you get how Liquid template markup works with comfy sofa, it becomes intuitive to create sites/layouts/pages.</p>

<p><strong><a href="https://github.com/websitescenes/cms_admin">CMS_Admin</a></strong></p>

<p>It is based on active_admin and uses devise for authentication.  It is Rails4 only but it is an app and not meant to be used with any existing Rails application.</p>

<h3>Conclusion</h3>

<p>I selected ComfortableMexicanSofa for its ease in integration into an existing Rails4 application with devise authentication.  The customization seems to be quite flexible.  It is also possible to invoke it from the main app which enables me to display help content in various places inside of the app.  The only requirement I haven&rsquo;t looked at is search.</p>

<p><strong>References</strong></p>

<p><a href="https://gist.github.com/ffmike/242751">A list of Rails CMS</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup/">The Never Ending Journey on the Perfect Blogging Setup</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-09-18T09:58:00+08:00" pubdate data-updated="true">Sep 18<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Once in a while I search for a better blogging solution.  Like many others I&rsquo;ve used Wordpress, Blogger, and Tumblr.  I&rsquo;ve also used more technical approaches such as self-hosted Wordpress.  I use <a href="http://octopress.org">Octopress</a> for this blog.  I have tempted to write my own blog software but some developers do.  Remy wrote his own <a href="http://www.whoisremy.com">blog</a> in RubyOnRails.</p>

<p>I recently needed to setup a blog for <a href="https://foryogi.com">ForYogi</a>.  I tried Tumblr, again, for a while.  I still don&rsquo;t like it.  I think it&rsquo;s better suited for a quick photo upload which some short description.  Instapaper&rsquo;s blog use it for obvious reason, but it&rsquo;s not visually appealing to me.  Knowing what Yahoo tends to do to their purchases, I decided to abandon it.  Wordpress is a bit too overwhelming for me, with its custom domain and many packages they sell.  I do like the plethora plugins and vibrant community Wordpress have though.  Blogger is the best choice for a hosted solution providing all I need for free.  I don&rsquo;t believe Blogger will be part of Google&rsquo;s killing spree as it is being used by many bloggers for advertising.  But its editing interface feels like MS Word in 1997.  Its post display is like a typical Google product, lacking the simplicity and elegancy of what Apple has.</p>

<p>I played around with <a href="http://roon.io">Roon</a> and liked their editing interface which supports Markdown.  They charge $12 annually for custom domain which you can get for free from many other services.  But that&rsquo;s fine, I&rsquo;m always up for supporting start-ups.  After making the first test post, I found something I don&rsquo;t quite like.  There&rsquo;s a rather large Roon icon on the posting, if you specify an image for it.  Roon seems to take the similar approach as Medium.  Focusing on content (hence no in-article commenting) is good.  But essentially you are writing <em><a href="http://www.marco.org/2013/08/05/be-your-own-platform">for free</a></em> for an online magazine.  The worst part though, is in their <a href="https://roon.io/terms">terms</a>:</p>

<blockquote><p>By submitting, posting or displaying content on or through the Service, you grant Nothing Magical Inc. a worldwide, non-exclusive, royalty-free license to use, adapt, publish, and display the content in any and all media or distribution methods (now known or later developed).</p></blockquote>

<p>To me, this is a <strong>deal-breaker</strong>.</p>

<p><a href="http://scriptgr.am">Scriptgr.am</a>, which integrates with Dropbox and has more features than Roon, is better suited for me.</p>

<p>Through the searching process, I figured out what I wanted:</p>

<ul>
<li>Support of markdown</li>
<li>Clean interface</li>
<li>True ownership of my content</li>
<li>Free custom domain</li>
<li>Least amount of coding</li>
<li>Ease of deployment and minimum effort of maintenance</li>
</ul>


<p><strong>My final setup is simple</strong></p>

<ul>
<li>Jekyll, a blog-aware static site generator</li>
<li>Mou, a desktop markdown editor</li>
<li>Github Pages</li>
</ul>


<p>Working with <a href="http://jekyllrb.com">Jekyll</a> is a pleasure.  I can use my editor of my choice to write postings and git to version control them.  Currently I&rsquo;m tinkering with <a href="mouapp.com">Mou</a>, a markdown editor.  I like its real-time preview pane and wishing emacs&#8217; markdown mode could offer it.  Github pages is fast and free.  I created a public repo &ndash; <a href="https://github.com/foryogi/foryogi.github.io">foryogi.github.io</a> and pushed to master.  Some online documentation mentions pushing to gh-pages branch, which did not work for me.  I also had to create a CNAME file by <code>echo "blog.foryogi.com" &gt; CNAME</code> at the root of project.  This is required for GH page redirect for subdomains to work.  Github has some problem with generating Jekyll-based pages and I haven&rsquo;t getting deployment emails at all.</p>

<p>I also added Twitter bootstrap and font-awesome.  I plan to add Google font to it next.  I also added support for Heroku, which requires Procfile, config.ru, and add a Heroku config var for the <a href="https://github.com/mattmanning/heroku-buildpack-ruby-jekyll">build pack</a>.  This <a href="https://github.com/mattmanning/heroku-buildpack-ruby-jekyll/pull/9">pull request</a> is useful to get around a build failure due to a change in Jekyll build command.</p>

<p>I prefer GH page to Heroku because the initial load of Heroku site is always very slow.  GH doesn&rsquo;t have that problem.  I added heroku for backup in case Github goes down. It&rsquo;s trivial to point CNAME to heroku app.  If Amazon EC2 is down, then I&rsquo;m out of luck (I think GH and Heroku both use EC2, but maybe they also use Rackspace).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/06/03/system-calls-in-ruby/">System Calls in Ruby</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-06-03T00:42:00+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/06/03/system-calls-in-ruby/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There are a few ways to execute system commands in Ruby: backticks, system, exec, %x[], and Open3#popen3.
We will take a look at the their differences and briefly discuss security concerns of applying them.</p>

<h2>Backticks (Kernel#`)</h2>

<p>When using backticks, the result is returned as string.  Process status of method execution is stored in $?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">006</span> <span class="o">&gt;</span> <span class="sb">`ls`</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">007</span> <span class="o">&gt;</span> <span class="vg">$?</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">_</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">success?</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>%x</h2>

<p>%x() or %x[] is similar to using backticks.</p>

<h2>Kernel#system</h2>

<p>When using system method, the result is true or false depending on whether the command is executed successfully.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'><span class="no">CHANGELOG</span><span class="o">.</span><span class="n">markdown</span> <span class="no">README</span><span class="o">.</span><span class="n">markdown</span>    <span class="n">config</span><span class="o">.</span><span class="n">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
</span><span class='line'><span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="o">.</span><span class="n">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="no">Gemfile</span><span class="o">.</span><span class="n">lock</span>       <span class="n">_config</span><span class="o">.</span><span class="n">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">&#39;ls a&#39;</span>
</span><span class='line'><span class="ss">ls</span><span class="p">:</span> <span class="ss">a</span><span class="p">:</span> <span class="no">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Kernel#exec</h2>

<p>exec replaces the current process by running the given external command.  If you invoke exec in irb, then the irb process
will be replaced by the running external command.  You will get the shell prompt back after exec finishes.  If you invoke
exec in a ruby program, that program will stop execution (just like the irb process).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="ss">mba</span><span class="p">:</span><span class="o">~</span><span class="sr">/projects/me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="n">irb</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">exec</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'><span class="no">CHANGELOG</span><span class="o">.</span><span class="n">markdown</span> <span class="no">README</span><span class="o">.</span><span class="n">markdown</span>    <span class="n">config</span><span class="o">.</span><span class="n">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
</span><span class='line'><span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="o">.</span><span class="n">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="no">Gemfile</span><span class="o">.</span><span class="n">lock</span>       <span class="n">_config</span><span class="o">.</span><span class="n">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="o">.</span><span class="n">old</span>
</span><span class='line'><span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="ss">mba</span><span class="p">:</span><span class="o">~</span><span class="sr">/projects/me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Open3#popen3</h2>

<p>popen3 executes the command while opening stdin, stdout, and stderr and a thread to wait for the command execution.</p>

<figure class='code'><figcaption><span>stdout with successfully execution </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">010</span> <span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;open3&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">011</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span> <span class="s1">&#39;ls&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 run&gt;]</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">012</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">_</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 dead&gt;]</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">014</span> <span class="o">&gt;</span> <span class="n">o</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>stderr with unsuccessfully execution </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">027</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;ls a&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="o">|</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">02</span><span class="mi">9</span><span class="o">?&gt;</span>   <span class="nb">p</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">030</span><span class="o">?&gt;</span>   <span class="k">end</span>
</span><span class='line'><span class="s2">&quot;ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="s2">&quot;ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a few variations of popen3 methods such as popen2 where a couple of streams are merged 2&amp;>1, for example.</p>

<h2>Security Concerns</h2>

<p>Much like SQL Injection, similar things can happen when using these method calls.
Consider a command like <code>ls a;rm a</code>.  or even worse <code>ls a;rm -rf *</code>
We can address such concerns with another form of popen3(cmd, args).  For the command above, it is
<code>popen3('ls', 'a;rm -rf*')</code>.  The last part of the command is interpreted as the options for <code>ls</code>.</p>

<p>Take a look at this playful little app <a href="https://github.com/zlu/web_shell">web_shell</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/29/initialization-is-an-interesting-thing/">Initialization Is an Interesting Thing</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-29T22:51:00+08:00" pubdate data-updated="true">May 29<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/29/initialization-is-an-interesting-thing/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever tried to define <code>initialized</code> method for an <code>ActiveRecord</code>?</p>

<p>Try it if you haven&rsquo;t.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyRecord &lt; ActiveRecord::Base
</span><span class='line'>  def initialize
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>MyRecord.new  #&lt;MyRecord not initialized&gt;
</span></code></pre></td></tr></table></div></figure>


<p>This is probably not what you have expected.  Why is MyRecord not initialized?</p>

<p>Well, ActiveRecord::Base has already defined <code>initialize</code> method.  It is used to instantiate Rails models.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def initialize(attributes = nil, options = {})</span></code></pre></td></tr></table></div></figure>


<p>If you really want to override it with your own version, you would want to do this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyRecord &lt; ActiveRecord::Base
</span><span class='line'>  def initialize(attributes = nil, options = {})
</span><span class='line'>    super
</span><span class='line'>    # now do your own initialization
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>MyRecord.new</span></code></pre></td></tr></table></div></figure>


<p>This should build a new AR for you (if you have a defined my_records table in database).</p>

<p>Rails provides a cleaner way to handle this via after_initilize callback.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyClass &lt; ActiveRecord::Base
</span><span class='line'>  after_initialize do
</span><span class='line'>    # do your thing here
</span><span class='line'>    puts 'more to do after initialization'
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><code>after_initialize</code> is called when ActiveRecord is instantiated and before it is saved.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/27/lost-shell-commands/">Lost Shell Commands?</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-27T21:32:00+08:00" pubdate data-updated="true">May 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/27/lost-shell-commands/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometime when you modify .bashrc or .bash_profile and source it, you may notice that you have &lsquo;lost&rsquo; your shell commands.
You will see &lsquo;command not found&rsquo; for the simplest commands such as <code>ls</code> and <code>which</code>.</p>

<p>Most like this happens because you have accidentally override your PATH.  So instead of doing:</p>

<p><code>PATH=my/custom/path:$PATH</code>, you did <code>PATH=my/custom/path</code>.</p>

<p>Here&rsquo;s a simpel way to fix it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'PATH=/bin:/usr/bin' &gt; foo && source foo</span></code></pre></td></tr></table></div></figure>


<p>This will get recover your commands so you can modify your .bashrc or .bash_profile with nano.  Remember to back up a working
version before working on them next time :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/02/04/postgres-gotchas/">Postgres Gotchas</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T11:16:00+08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/04/postgres-gotchas/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I run postgres locally for development on OS X (mountain lion).  I&rsquo;ve run into a few issues and am documenting solutions
here.</p>

<h2>Issue 1: Insufficient Shared Memory</h2>

<p>Postgres requires sufficient shared memory or it won&rsquo;t start.  If there isn&rsquo;t enough, postgres server will fail to start
and in server.log you will see this:</p>

<pre><code>FATAL:  could not create shared memory segment: Cannot allocate memory
DETAIL:  Failed system call was shmget(key=5432001, size=3391488, 03600).
HINT:  This error usually means that PostgreSQL's request for a shared memory segment exceeded available memory or swap space, or exceeded your kernel's SHMALL parameter.  You can either reduce the request size or reconfigure the kernel with larger SHMALL.  To reduce the request size (currently 3391488 bytes), reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections.
</code></pre>

<p>There are two ways to correct this problem.</p>

<ol>
<li><p>Up the shared memory configuration.</p>

<p> On mountain lion, you could create or modify your /etc/sysctl.conf so it has this:</p>

<pre><code> zlu@zlu-mba:~/projects/me/blog-zlu (master)$ cat /etc/sysctl.conf
 kern.sysv.shmmax=4194304
 kern.sysv.shmmin=1
 kern.sysv.shmmni=32
 kern.sysv.shmseg=8
 kern.sysv.shmall=1024
</code></pre>

<p> Make sure shmmax is large enough for postgres and other software that requires shared memeory.
 To figure out how much shared memeory you will need for postgres, take a look at postgresql.conf (probably under /usr/local/var/postgres)</p>

<pre><code> max_connections = 20                    # (change requires restart)
 # Note:  Increasing max_connections costs ~400 bytes of shared memory per
 # connection slot, plus lock space (see max_locks_per_transaction).
</code></pre>

<p> More details can be found here:
 <a href="http://www.postgresql.org/docs/9.2/static/kernel-resources.html#SYSVIPC">Upgrade Postgres</a></p></li>
<li><p>Reduce resource requirements
 In postgresql.conf you could search for &ldquo;shared memory&rdquo; and see all resources (such as max_connections and max_prepared_transactions).
 Reduce the requirements as you see fit.</p></li>
</ol>


<h2>Issue 2: Upgrading from 9.1.x to 9.2.x</h2>

<p>If you need to migration database, you may run into path issues.</p>

<p>Here is the steps that work for me:</p>

<ol>
<li>Backup <strong>BEFORE</strong> you install 9.2 (with homebrew).  This is important if you want to avoid the hussle later with two versions
 of <code>pg_ctl</code> stomping onto each other.  While the 9.1.x server is running, use <code>pg_dumpall</code> to export the database.</li>
<li>Stop 9.1.x server</li>
<li>mv the data directory (e.g. /usr/local/var/postgres) to postgres.bk.</li>
<li>Install postgres 9.2.x (with homebrew).</li>
<li>Create symlink for plist file for launchctl (it is named differently than 9.1 so you will need to do it again).  The post-install
 instruction of homebrew contains the exact command.
     cp /usr/local/Cellar/postgresql/9.2.1/homebrew.mxcl.postgresql.plist ~/Library/LaunchAgents/
 And remove the plist file that belonged to 9.1.x</li>
<li><code>initdb</code> (this creates the 9.2.x version of the database).</li>
<li>Import the postgres data backup from the previous <code>pg_dumpall</code> command.</li>
<li>Load plist:
     launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.postgresql.plist</li>
</ol>


<p><a href="http://www.postgresql.org/docs/9.2/static/upgrading.html">Migrating Postgres</a></p>

<h2>Issue 3: Rails Server Fails to Start</h2>

<p>If you are doing Rails development, after upgrade postgres and issue &lsquo;rails s&rsquo; for your project, you may see this error
which fails Rails server from starting:</p>

<pre><code>PGError (could not connect to server: Permission denied
    Is the server running locally and accepting
    connections on Unix domain socket "/var/pgsql_socket/.s.PGSQL.5432"?
)
</code></pre>

<p>Since postgres 9.2, the unix socket file has changed to /var/pgsql_socket/alt.  The pg gem is compiled against the older version
of postgres (9.1.x) so it looks for the socket file in wrong location.  The easist thing to do is to uninstall and reinstall
pg gem.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/11/10/housekeeping-rvm/">Housekeeping RVM</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-10T18:13:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/10/housekeeping-rvm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When a new version of Ruby comes out, I like to use RVM to install it, migrate ruby gems to new ruby, and remove the
older version of ruby.  This prevent the disk bloated with different versions of Rubies and duplicate gem(sets).</p>

<p>First, always update the RVM because it&rsquo;ll also update known list of Ruby.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm get stable
</span></code></pre></td></tr></table></div></figure>


<p>Then list known versions of Rubies</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm list known
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-p286
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-<span class="o">[</span>p327<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>1.9.3-head
</span><span class='line'><span class="o">[</span>ruby-<span class="o">]</span>2.0.0-preview1
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>The output shows abridged result since the full list is long.  I currently have p286 installed and I&rsquo;m about to install p327
because it contains a security fix for DoS attack in p286.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm install 1.9.3
</span></code></pre></td></tr></table></div></figure>


<p>Since p327 is the default stable version (as indicated by []), the command above is sufficient.</p>

<p>Now you can migrate the gem(sets)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm migrate 1.9.3-p286 1.9.3-p327
</span></code></pre></td></tr></table></div></figure>


<p>As part of the migration, you could opt to remove old ruby version.  Then check the disk usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rvm disk-usage all
</span></code></pre></td></tr></table></div></figure>


<h2>Note</h2>

<p><a href="https://github.com/wayneeseguin/rvm">RVM</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/11/08/what-happened-to-fd-3-and-4-in-mri/">What Happened to FD 3 and 4 in MRI</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-08T16:07:00+08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/08/what-happened-to-fd-3-and-4-in-mri/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I got curious when this happened:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">032</span> <span class="o">&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fileno</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>I know that file descriptors (FD) 0, 1, and 2 are assigned to STDIN, STDOUT, and STDERR.  I also know that FDs are assigned
in order.  So what happened to 3 and 4?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">015</span> <span class="o">&gt;</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">fileno</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="n">p286</span> <span class="p">:</span><span class="mo">034</span> <span class="o">&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">for_fd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="no">ArgumentError</span><span class="p">:</span> <span class="no">The</span> <span class="n">given</span> <span class="n">fd</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">accessible</span> <span class="n">because</span> <span class="no">RubyVM</span> <span class="n">reserves</span> <span class="n">it</span>
</span><span class='line'>  <span class="n">from</span> <span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">34</span><span class="ss">:in</span> <span class="sb">`for_fd&#39;</span>
</span><span class='line'><span class="sb"> from (irb):34</span>
</span><span class='line'><span class="sb"> from /Users/zlu/.rvm/rubies/ruby-1.9.3-p286/bin/irb:16:in `</span><span class="o">&lt;</span><span class="n">main</span><span class="o">&gt;</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Evidently some ruby process is using it, but what process?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~<span class="nv">$ </span>lsof -d 3,4 | grep ruby
</span><span class='line'>ruby      4980  zlu    3     PIPE 0xffffff8029fa7860     16384           -&gt;0xffffff8029fa4370
</span><span class='line'>ruby      4980  zlu    4     PIPE 0xffffff8029fa4370     16384           -&gt;0xffffff8029fa7860
</span><span class='line'>
</span><span class='line'>COMMAND    PID  USER   FD    TYPE DEVICE                  SIZE/OFF   NODE NAME
</span></code></pre></td></tr></table></div></figure>


<p>And</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zlu@zlu-mba:~<span class="nv">$ </span>ps -p 4980
</span><span class='line'>  PID TTY           TIME CMD
</span><span class='line'> 4980 ttys003    0:00.47 irb
</span></code></pre></td></tr></table></div></figure>


<p>So Ruby&rsquo;s RVM is using <em>pipes</em> with FD 3 and 4.  As far as what these pipes are used for, that&rsquo;ll be another discussion.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2012/11/07/rolling-deployment/">Rolling Deployment</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-07T20:30:00+08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/07/rolling-deployment/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is common to deploy new code to production several times a week (or even a day) in an agile shop.  How to make deployment
less intrusive to end user has becoming a larger issue.  If you simply use <code>cap deploy production</code>, some web requests will
time out hence hamper consumer experience.  Heroku supports maintenance mode, which can be turned on before a deployment.
User will see a maintenance page instead of unresponsive web page.  This is ok but not ideal.</p>

<p>Martin Fowler wrote about <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Blue Green Deployment</a>.  The canonical
form of this deployment strategy is to maintain two identical databases for each environment.  There is an issue of
dealing with missed transactions when deploying to one environment (stand-by) while the live environment is still taking
web requests.  There are a few ways to take care of this such as putting the live environment into read-only mode before the
cut-over.</p>

<p>For a small application (or a typical start-up scenario), having two database is a bit of over-kill and entails higher
operational costs.  With rolling deployment,  all the production web (application) servers share the same database.  To
reduce application downtime, only one web server will be taken out of the load balancer at a time.  This web server will then
be loaded with new code.  We can then run some quick automated tests (simple selenium tests for example) to ensure the build
is sane, against this web server.  If tests pass, we bring the node back into the load balancer.  We then repeat this process
for the next server.  If there are database changes that could potentially affect the state of the application and cause
inconsistency, then measure must be taken in the application to mitigate the problem through for example, back-fill.</p>

<h2>Setup</h2>

<p>A typical setup for a web app where multiple web servers (such as Unicorn) share the same database server.</p>

<pre>
                  |-> web server1 (red)   -|
load balancer --> |-> web server2 (blue)  -|---> database
                  |-> web server3 (green) -|
</pre>


<h2>Steps</h2>

<ul>
<li>Take the red web server out of load balancer</li>
<li>Deploy new code to red</li>
<li>Run deployment tests against red to ensure everything is sane</li>
<li>If tests pass, put red back to load balancer and continue to the next node, blue</li>
<li>If tests fail, roll back</li>
</ul>


<h2>Example</h2>

<p>In this example, I use Apache&rsquo;s <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy_balancer.html">mod_proxy_balancer</a>.
I use a typical Rails web server setup and <a href="https://github.com/capistrano/capistrano">Capistrano</a> for deployment.</p>

<figure class='code'><figcaption><span>In Rails&#8217; production.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server1.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:red</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server2.com&quot;</span><span class="p">,</span> <span class="ss">:group</span><span class="o">=&gt;</span> <span class="ss">:blue</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;server3.com&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:green</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:apache</span><span class="p">,</span> <span class="s2">&quot;loadbalancer.com&quot;</span><span class="p">,</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>In Capistrano&#8217;s deploy.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">manage_node</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span><span class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">roles</span><span class="o">[</span><span class="ss">:apache</span><span class="o">]</span><span class="si">}</span><span class="s2">/balancer-manager&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response_body</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>  <span class="n">nonce</span> <span class="o">=</span> <span class="n">response_body</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/nonce=(.*)\&quot;/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">node</span> <span class="o">=</span> <span class="n">find_servers</span><span class="p">(</span><span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:group</span> <span class="o">=&gt;</span> <span class="n">group</span><span class="o">.</span><span class="n">to_sym</span><span class="p">})</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:w</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">node</span><span class="si">}</span><span class="s2">:8080&quot;</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="n">stage</span><span class="p">,</span> <span class="ss">:nonce</span> <span class="o">=&gt;</span> <span class="n">nonce</span><span class="p">,</span> <span class="ss">:dw</span> <span class="o">=&gt;</span> <span class="n">action</span><span class="p">}</span>
</span><span class='line'>  <span class="n">uri</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode_www_form</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;200&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>mod_proxy_balancer has a balancer-manager GUI.  Admin is able to enable and disable node (web server) via a form.
manage_node method essentially submit the form to the balancer-manager.</p>

<p>To take red node out of the load balancer, simply define a task such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:enable</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">manage_mode</span><span class="p">(</span><span class="s2">&quot;Enable&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">),</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The value of group can be passed in as a command line option for Capistrano</p>

<h2>Other Considerations</h2>

<p>Why do I suggest running some basic tests as the acceptance criteria for rolling deployment?  I assume that the code
being deployed is well tested and passed CI/QA etc.  But there&rsquo;re all kinds of factors that can be different between test,
CI, and production environment.  Some library have different versions, VM images, or even the OS can be different.  I like
to use a Mac Mini for in-house CI (or Travis for open-source projects).  There&rsquo;s no guarantee that Travis or Mac Mini
can be kept up-to-date with production environment.  I could spin up a CI instance that replicates production but keeping
them in-sync still takes much effort.  There are also possibilities that integration test suites do not test views where
a simple route change could prevent user from successfully logging in.  By running a simple Selenium test to login and
perform one core function of the application, it gives me some level of assurance.</p>

<p>Capistrano supports deployment to a single server using HOSTS or HOSTFITLER command line options.  However, the load balancer
will keep sending requests to the server during deployment and server restart.</p>

<h2>Note</h2>

<p><a href="http://rdoc.info/github/capistrano/capistrano/master/Capistrano/Configuration/Servers">find_server API</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
	<h1>Flickr</h1>
	<div class="flickr">
		<script type="text/javascript" src="http://www.flickr.com/badge_code_v2.gne?count=4&display=random&size=t&layout=v&source=user&user=76883175@N03"></script>
	</div>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/29/site-updates/">Site Updates</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/27/quicksurveyofrailscms/">Quick Survey Of Rails CMS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup/">The Never Ending Journey On The Perfect Blogging Setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/03/system-calls-in-ruby/">System Calls In Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/29/initialization-is-an-interesting-thing/">Initialization Is An Interesting Thing</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Yoga Playlist</h1>
    <iframe src="https://embed.spotify.com/?uri=spotify:user:zlu2:playlist:4hBWbRE1bHyJQ9y6iKWZqW&theme=white"
            width="250"
            height="380"
            frameborder="0"
            allowtransparency="true"></iframe>
</section>
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
      <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/zlu"  data-widget-id="380137827368853504"  data-link-color="#1863a1" data-tweet-limit="4" data-chrome="noheader nofooter transparent noscrollbar">Tweets by @zlu</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </ul>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/zlu" class="twitter-follow-button" data-show-count="true">Follow @zlu</a>
  
</section>

<section>
    <h1>Change Log</h1>
    <ul><li>Oct 08 - <a href='https://github.com/zlu/octopress/commit/194b39eea4b58e54cc4cd46b4598bed55c39d0d3/'>Revert &#8220;temporarily added widget from networked blos for site verification&#8221;

This reverts commit 7c7216d5605a0cfe5a93e8381e2eecd94c4163ea.</a></li><li>Oct 08 - <a href='https://github.com/zlu/octopress/commit/7c7216d5605a0cfe5a93e8381e2eecd94c4163ea/'>temporarily added widget from networked blos for site verification</a></li><li>Sep 30 - <a href='https://github.com/zlu/octopress/commit/630a3d9fd48bee28c9db08adeeb5d9ff18835830/'>merging&#8230;</a></li><li>Sep 30 - <a href='https://github.com/zlu/octopress/commit/eff157a313accaecd893ddf303fa7c33b8bc398c/'>Added update2 to cms blog - correction on comfy _not_ using liquid</a></li><li>Sep 30 - <a href='https://github.com/zlu/octopress/commit/c197932a27f6a30441b544607161634a47bbc679/'>Added update2 to cms blog - correction on comfy _not_ using liquid</a></li><li>Sep 29 - <a href='https://github.com/zlu/octopress/commit/f515acd92f1d25443c1d9a32ca6dce36c4950a5e/'>Site updates</a></li><li>Sep 29 - <a href='https://github.com/zlu/octopress/commit/e7e3897b367698fecae43e743ff34b0162d5a78b/'>Minor change to time format for change log</a></li><li>Sep 29 - <a href='https://github.com/zlu/octopress/commit/b8053a2395d98e8da09931bb8e1b809338732590/'>Added new favicon</a></li><li>Sep 29 - <a href='https://github.com/zlu/octopress/commit/d3ca7d977f80c2424f9e133ed4dfa4c177c9dd7a/'>merging&#8230;</a></li><li>Sep 29 - <a href='https://github.com/zlu/octopress/commit/1bdab367f501fc5570e62b0cca9ed62a9c143d96/'>Merge branch &#8216;master&#8217; of github.com:zlu/octopress</a></li></ul>
</section><html xmlns:wb=“http://open.weibo.com/wb”>
<head>
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
</head>


<section>
    <wb:follow-button uid="2091903003" type="gray_2" width="136" height="24" ></wb:follow-button>
</section>


</html>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Zhao Lu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zlu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






</body>
</html>
